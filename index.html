<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invoice PDF Parser & Editor — Steel/Aluminum Sublines (Min Patch)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Arial, sans-serif;background:#f5f7fa;padding:20px}
    .container{max-width:1800px;margin:0 auto;background:#fff;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:30px;border-radius:8px 8px 0 0}
    .header h1{margin-bottom:8px}
    .upload-section{padding:40px;text-align:center}
    .upload-box{border:3px dashed #cbd5e0;border-radius:8px;padding:40px;cursor:pointer;transition:.3s}
    .upload-box:hover{border-color:#667eea;background:#f7fafc}
    .upload-box.dragover{border-color:#667eea;background:#e6f0ff}
    #fileInput{display:none}
    .loading{padding:40px;text-align:center;display:none}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 20px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .controls{padding:20px;background:#f8f9fa;border-bottom:1px solid #dee2e6;display:none}
    .controls select{padding:10px;border:1px solid #ced4da;border-radius:4px;font-size:14px;min-width:400px;margin-right:10px}
    .controls button{padding:10px 20px;border:none;border-radius:4px;font-weight:600;cursor:pointer;margin-right:10px}
    .btn-success{background:#28a745;color:#fff}.btn-success:hover{background:#218838}
    .btn-primary{background:#007bff;color:#fff}.btn-primary:hover{background:#0056b3}
    .btn-danger{background:#dc3545;color:#fff}.btn-danger:hover{background:#c82333}
    .btn-secondary{background:#6c757d;color:#fff}.btn-secondary:hover{background:#5a6268}
    .table-container{padding:20px;overflow:auto}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #e9ecef;padding:8px 10px;font-size:14px;vertical-align:top}
    th{background:#f1f3f5;position:sticky;top:0}
    .row-actions{display:flex;gap:6px}
    .footer{padding:20px;border-top:1px solid #e9ecef;display:flex;gap:10px;align-items:center}
    .status{font-size:12px;color:#555}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Invoice PDF Parser & Editor — Steel/Aluminum Sublines</h1>
      <p>Minimal patch: keeps your original UI/logic, only adds a normalization pass for broken labels like <em>"St eel Packaging"</em>.</p>
    </div>

    <div class="upload-section">
      <label class="upload-box" id="dropZone">
        <strong>Click to choose PDFs</strong> or drag & drop here
        <input type="file" id="fileInput" accept="application/pdf" multiple />
      </label>
    </div>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div>Reading PDF text…</div>
    </div>

    <div class="controls" id="controls">
      <select id="invoiceSelect"></select>
      <button class="btn-secondary" id="addLineBtn">Add Line Below</button>
      <button class="btn-danger" id="deleteLineBtn">Delete Selected</button>
      <button class="btn-success" id="exportBtn">Export to Excel</button>
    </div>

    <div class="table-container">
      <table id="dataTable">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll"></th>
            <th>Invoice #</th>
            <th>POS</th>
            <th>Part Number</th>
            <th>Description</th>
            <th>Qty</th>
            <th>UOM</th>
            <th>Unit Price</th>
            <th>Line Total</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <div class="footer">
      <div class="status" id="status">Ready.</div>
    </div>
  </div>

  <script>
    // ============= ORIGINAL HELPERS (unchanged) =============
    let allData = [];
    let invoiceOrder = [];

    function parseFloatSafe(s){ if(s==null) return NaN; const t=String(s).replace(/[\s,]/g,''); const v=parseFloat(t); return isNaN(v)?NaN:v; }

    // --- Normalizes broken intra-word spacing like "St eel", "w eight", etc. ---
    function normalizeWeirdSpacing(s){
      const esc = (ch)=>ch.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
      const squish = (word)=>{
        const pat = new RegExp(word.split('').map(esc).join('\\s*'),'ig');
        return (txt)=>txt.replace(pat, word);
      };
      const common = ['Steel','Aluminum','Packaging','Content','Quantity','per','PCS','Total','net','weight','value','customs','KG','invoice','Country','origin','product'];
      let out = s;
      for(const w of common){ out = squish(w)(out); }
      out = out
        .replace(/9903\.81\.91\s*-\s*S\s*t\s*e\s*e\s*l\s*\s*P\s*a\s*c\s*k\s*a\s*g\s*i\s*n\s*g/ig, '9903.81.91 - Steel Packaging')
        .replace(/9903\.85\.08\s*-\s*A\s*l\s*u\s*m\s*i\s*n\s*u\s*m\s*\s*C\s*o\s*n\s*t\s*e\s*n\s*t/ig, '9903.85.08 - Aluminum Content')
        .replace(/Total\s+net\s+steel\s+weight\s*(?:per\s*KG)?\s*:/ig, 'Total net steel weight per KG:')
        .replace(/Total\s+net\s+aluminum\s+weight\s*(?:per\s*KG)?\s*:/ig, 'Total net aluminum weight per KG:')
        .replace(/Steel\s*content\s*per\s*PCS\s*:/ig, 'Steel content per PCS:')
        .replace(/Aluminum\s*content\s*per\s*PCS\s*:/ig, 'Aluminum content per PCS:')
        .replace(/Quantity\s*per\s*PCS\s*:/ig, 'Quantity per PCS:')
        .replace(/Total\s+customs\s+value\s*:/ig, 'Total customs value:');
      return out;
    }

    function fmt2(n){ const v=parseFloatSafe(n); return isNaN(v)?'':v.toFixed(2); }

    function setStatus(msg){ document.getElementById('status').textContent = msg; }

    function esc(s){ return (s+'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    // ============= LOADING & UI (unchanged) =============
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const invoiceSelect = document.getElementById('invoiceSelect');
    const tableBody = document.getElementById('tableBody');
    const selectAll = document.getElementById('selectAll');

    dropZone.addEventListener('click', ()=> fileInput.click());
    dropZone.addEventListener('dragover', e=>{ e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', ()=> dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', e=>{ e.preventDefault(); dropZone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
    fileInput.addEventListener('change', ()=> handleFiles(fileInput.files));

    async function handleFiles(files){
      document.getElementById('loading').style.display='block';
      setStatus('Reading PDFs…');
      allData=[]; invoiceOrder=[]; tableBody.innerHTML=''; invoiceSelect.innerHTML='';
      try{
        for(const f of files){ await parsePdf(f); }
        buildInvoiceDropdown();
        document.getElementById('controls').style.display='block';
        setStatus(`Loaded ${files.length} file(s).`);
      }catch(err){ console.error(err); alert('Error reading PDFs: '+err.message); }
      finally{ document.getElementById('loading').style.display='none'; }
    }

    async function parsePdf(file){
      const buf = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({data:new Uint8Array(buf)}).promise;
      let text='';
      for(let p=1;p<=pdf.numPages;p++){
        const page = await pdf.getPage(p);
        const tc = await page.getTextContent();
        const line = tc.items.map(it=>String(it.str||'').replace(/\s+/g,' ').trim()).join(' ');
        text += line + "\n";
      }
      parseInvoices(text);
    }

    // ============= PARSER (almost unchanged) =============
    function parseInvoices(text){
      // Your original logic populates allData with base lines and appends S/A sublines.
      // Only change below: we normalize each itemSection before regex matching.

      // --- existing code that finds invoice ranges, base lines, etc. ---
      // (This block mirrors your original; elided for brevity in this minimal example.)

      // For demonstration, we stub a minimal iterator over detected items/sections.
      // Replace this whole function body with your original parseInvoices,
      // then apply the TWO-line change shown in the STEEL/ALUM blocks below.

      const sections = detectItemsAndSections(text); // stands in for your original logic
      for(const sec of sections){
        const sectionText = sec.sectionText;
        const startPos = 0; // from your original
        const endPos = sectionText.length; // from your original

        const itemSection = sectionText.substring(startPos, Math.min(endPos, sectionText.length));
        // >>> MINIMAL PATCH LINE 1: create a normalized copy
        const __norm = normalizeWeirdSpacing(itemSection);

        // --- Parse Steel block (unchanged patterns) ---
        // >>> MINIMAL PATCH LINE 2: use __norm for the match
        const steelBlockMatch = __norm.match(/9903\.81\.91\s*-\s*Steel\s*Packaging([\s\S]*?)(?:9903\.85\.08|Total\s+invoice\s+value|Country\s+of\s+origin|Net\s+product\s+value|$)/i);
        let steelWeightKG = NaN, steelCustomsUSD = NaN;
        if(steelBlockMatch){
          const steelBlock = steelBlockMatch[1];
          const w1 = steelBlock.match(/Total\s+net\s+steel\s+weight\s+per\s+KG:\s*([\d,.]+)/i);
          if(w1) steelWeightKG = parseFloatSafe(w1[1]);
          if(isNaN(steelWeightKG)){
            const cpcs = steelBlock.match(/Steel\s+content\s+per\s+PCS:\s*([\d,.]+)\s*KG/i);
            const qpcs = steelBlock.match(/Quantity\s+per\s+PCS:\s*([\d,.]+)/i);
            if(cpcs && qpcs){ steelWeightKG = parseFloatSafe(cpcs[1]) * parseFloatSafe(qpcs[1]); }
          }
          const cvalS = steelBlock.match(/Total\s+customs\s+value\s*:\s*([\d,.]+)\s*USD/i);
          if(cvalS) steelCustomsUSD = parseFloatSafe(cvalS[1]);
          pushSublineS(sec, steelWeightKG, steelCustomsUSD); // your original function
        }

        // --- Parse Aluminum block (unchanged patterns) ---
        const alumBlockMatch = __norm.match(/9903\.85\.08\s*-\s*Aluminum\s*Content([\s\S]*?)(?:9903\.81\.91|Total\s+invoice\s+value|Country\s+of\s+origin|Net\s+product\s+value|$)/i);
        let alumQty = NaN, alumCustomsUSD = NaN, alumUnit='KG';
        if(alumBlockMatch){
          const alumBlock = alumBlockMatch[1];
          const aq = alumBlock.match(/Total\s+aluminum\s+content:\s*([\d,.]+)/i);
          if(aq) alumQty = parseFloatSafe(aq[1]);
          const cvalA = alumBlock.match(/Total\s+customs\s+value\s*:\s*([\d,.]+)\s*USD/i);
          if(cvalA) alumCustomsUSD = parseFloatSafe(cvalA[1]);
          pushSublineA(sec, alumQty, alumCustomsUSD, alumUnit); // your original function
        }
      }
    }

    // ====== The rest of your original UI/export/render code would remain here ======

    // ----- Minimal scaffolding so the page runs -----
    function detectItemsAndSections(text){
      // In your original, you detect invoices and items; here we just return one fake section
      // so the file runs without your full source. Replace with your original detection code.
      return [{ sectionText: text, invoice:"", pos:"" }];
    }
    function pushSublineS(sec, kg, usd){
      allData.push({ invoice: sec.invoice||'', pos: (sec.pos||'')+'S', part_number:'', description:'Steel subline (9903.81.91)', qty: isNaN(kg)?'':fmt2(kg), uom: isNaN(kg)?'':'KG', unit_price:'', line_total: isNaN(usd)?'':fmt2(usd), notes:'' });
      renderTable();
    }
    function pushSublineA(sec, qty, usd, unit){
      allData.push({ invoice: sec.invoice||'', pos: (sec.pos||'')+'A', part_number:'', description:'Aluminum subline (9903.85.08)', qty: isNaN(qty)?'':fmt2(qty), uom: isNaN(qty)?'':(unit||'KG'), unit_price:'', line_total: isNaN(usd)?'':fmt2(usd), notes:'' });
      renderTable();
    }

    function buildInvoiceDropdown(){
      const s = new Set(allData.map(r=>r.invoice));
      invoiceOrder = [...s];
      invoiceSelect.innerHTML = invoiceOrder.map(no=>`<option value="${esc(no)}">${esc(no)}</option>`).join('');
      document.getElementById('controls').style.display='block';
    }

    function renderTable(){
      tableBody.innerHTML = allData.map((r,i)=>`
        <tr>
          <td><input type="checkbox" data-idx="${i}"></td>
          <td>${esc(r.invoice||'')}</td>
          <td>${esc(r.pos||'')}</td>
          <td>${esc(r.part_number||'')}</td>
          <td>${esc(r.description||'')}</td>
          <td style="text-align:right">${esc(r.qty||'')}</td>
          <td>${esc(r.uom||'')}</td>
          <td style="text-align:right">${esc(r.unit_price||'')}</td>
          <td style="text-align:right">${esc(r.line_total||'')}</td>
          <td>${esc(r.notes||'')}</td>
        </tr>`).join('');
    }
  </script>
</body>
</html>
