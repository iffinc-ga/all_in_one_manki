<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invoice PDF Parser & Descartes Exporter</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Arial, sans-serif;background:#f5f7fa;padding:20px}
    .container{max-width:1800px;margin:0 auto;background:#fff;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:30px;border-radius:8px 8px 0 0}
    .header h1{margin-bottom:8px}
    .upload-section{padding:40px;text-align:center}
    .upload-box{border:3px dashed #cbd5e0;border-radius:8px;padding:40px;cursor:pointer;transition:.3s}
    .upload-box:hover{border-color:#667eea;background:#f7fafc}
    .upload-box.dragover{border-color:#667eea;background:#e6f0ff}
    #fileInput{display:none}
    .loading{padding:40px;text-align:center;display:none}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 20px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .controls{padding:20px;background:#f8f9fa;border-bottom:1px solid #dee2e6;display:none}
    .controls select{padding:10px;border:1px solid #ced4da;border-radius:4px;font-size:14px;min-width:400px;margin-right:10px}
    .controls button{padding:10px 20px;border:none;border-radius:4px;font-weight:600;cursor:pointer;margin-right:10px}
    .btn-success{background:#28a745;color:#fff}.btn-success:hover{background:#218838}
    .btn-primary{background:#007bff;color:#fff}.btn-primary:hover{background:#0056b3}
    .btn-danger{background:#dc3545;color:#fff}.btn-danger:hover{background:#c82333}
    .btn-info{background:#17a2b8;color:#fff}.btn-info:hover{background:#138496}
    .btn-warning{background:#ffc107;color:#212529}.btn-warning:hover{background:#e0a800}
    .stats{padding:20px;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;background:#fff3cd;display:none}
    .stat{padding:15px;background:#fff;border-radius:4px;border-left:4px solid #ffc107}
    .stat-label{font-size:11px;color:#6c757d;text-transform:uppercase;margin-bottom:5px}
    .stat-value{font-size:20px;font-weight:700}
    .stat-value.error{color:#dc3545}.stat-value.success{color:#28a745}
    .stat input{width:100%;padding:6px;border:1px solid #ced4da;border-radius:3px;font-size:16px;font-weight:bold}
    .stat.editable{border-left-color:#007bff}
    .table-container{padding:20px;display:none}
    .table-header-wrapper{background:#343a40;overflow:auto}
    .table-header-wrapper::-webkit-scrollbar{display:none}
    .table-header-wrapper{scrollbar-width:none}
    .table-header{min-width:1200px}
    .table-header table{width:100%;border-collapse:collapse}
    .table-header th{background:#343a40;color:#fff;padding:12px 8px;text-align:left;font-weight:600;font-size:13px;border:none}
    .table-body-wrapper{max-height:560px;overflow:auto}
    .table-body{min-width:1200px}
    .table-body table{width:100%;border-collapse:collapse}
    .table-body td{padding:10px 8px;border-bottom:1px solid #dee2e6;background:#fff}
    .table-body tr:hover td{background:#f8f9fa}
    .table-body td input{width:100%;padding:6px;border:1px solid #ced4da;border-radius:3px;font-size:13px}
    .table-body td input:focus{outline:none;border-color:#667eea}
    .readonly{background:#e9ecef!important}
    .actions{text-align:center}
    .actions button{padding:4px 8px;font-size:12px;margin:0 2px}
    .inline-help{font-size:12px;color:#6c757d;margin-left:8px}
    .db-section{padding:20px;background:#e7f3ff;border-bottom:1px solid #b3d9ff}
    .db-status{display:inline-block;padding:5px 10px;border-radius:4px;font-size:12px;margin-left:10px}
    .db-loaded{background:#d4edda;color:#155724}
    .db-loading{background:#fff3cd;color:#856404}
    .db-error{background:#f8d7da;color:#721c24}
    .db-info{font-size:12px;color:#004085;margin-top:5px}
  
    /* Column alignment */
    .table-header table, .table-body table{table-layout:fixed}
    .table-header th:nth-child(1), .table-body td:nth-child(1){width:44px!important}
    .table-header th:nth-child(2), .table-body td:nth-child(2){width:210px!important}
    .table-header th:nth-child(3), .table-body td:nth-child(3){width:80px!important}
    .table-header th:nth-child(4), .table-body td:nth-child(4){width:56px!important}
    .table-header th:nth-child(5), .table-body td:nth-child(5){width:120px!important}
    .table-header th:nth-child(6), .table-body td:nth-child(6){width:120px!important}
    .table-header th:nth-child(7), .table-body td:nth-child(7){width:96px!important}
    .table-header th:nth-child(8), .table-body td:nth-child(8){width:64px!important}
    .table-header th:nth-child(9), .table-body td:nth-child(9){width:140px!important}
    .table-body td{padding:6px 6px}
    .table-body td input{width:100%;}
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ðŸ“„ Invoice PDF Parser & Descartes Exporter</h1>
    <p>Parse invoices and export to Descartes OneView Template with auto-loaded database</p>
  </div>

  <div class="db-section" id="dbSection">
    <strong>Database Status:</strong>
    <span class="db-status db-loading" id="dbStatus">Loading database from repository...</span>
    <div class="db-info" id="dbInfo">Fetching updated_manki_db.xlsx from GitHub...</div>
  </div>

  <div class="upload-section" id="uploadSection">
    <div class="upload-box" id="uploadBox">
      <h2>ðŸ“¤ Upload PDF Invoice</h2>
      <p style="margin-top:10px;color:#6c757d">Click or drag & drop your PDF file here</p>
      <input type="file" id="fileInput" accept=".pdf,application/pdf" />
    </div>
  </div>

  <div class="loading" id="loading">
    <div class="spinner"></div>
    <div><strong>Processing PDF...</strong></div>
  </div>

  <div class="alert" id="alert" style="display:none"></div>

  <div class="controls" id="controls">
    <select id="invoiceSelect"><option value="">Select an invoice...</option></select>
    <button class="btn-warning" onclick="exportToDescartes()">ðŸ“‹ Export to Descartes Template</button>
    <button class="btn-success" onclick="exportToExcel()">ðŸ“¥ Export to Excel</button>
    <button class="btn-info" onclick="addBlankRowForCurrent()">âž• Add Blank Row</button>
    <button class="btn-primary" onclick="resetUpload()">ðŸ“¤ New Upload</button>
    <span class="inline-help">Tip: Use <strong>Tab</strong>/<strong>Shift+Tab</strong> or <strong>Enter</strong> to move between fields.</span>
  </div>

  <div class="stats" id="stats">
    <div class="stat"><div class="stat-label">Invoice Number</div><div class="stat-value" id="statInvoice">-</div></div>
    <div class="stat editable"><div class="stat-label">Invoice Date (Editable)</div><input autocomplete="off" type="text" id="statDate" placeholder="MM/DD/YYYY" onchange="updateInvoiceField('invoice_date', this.value)"></div>
    <div class="stat editable"><div class="stat-label">Supplier (Editable)</div><input autocomplete="off" type="text" id="statSupplier" placeholder="Supplier name" onchange="updateInvoiceField('supplier', this.value)"></div>
    <div class="stat"><div class="stat-label">Total Line Items</div><div class="stat-value" id="statItems">0</div></div>
    <div class="stat editable"><div class="stat-label">Invoice Total (Editable)</div><input autocomplete="off" type="number" step="0.01" id="statTotal" placeholder="0.00" onchange="updateInvoiceTotal(this.value)"></div>
    <div class="stat"><div class="stat-label">Line Items Sum</div><div class="stat-value" id="statSum">$0.00</div></div>
    <div class="stat"><div class="stat-label">Difference</div><div class="stat-value" id="statDiff">$0.00</div></div>
  </div>

  <div class="table-container" id="tableContainer">
    <div class="table-header-wrapper">
      <div class="table-header">
        <table><thead><tr>
          <th style="width:48px">Pos</th>
          <th style="width:210px">Part Number</th>
          <th style="width:90px">Quantity</th>
          <th style="width:64px">Unit</th>
          <th style="width:120px">Unit Price</th>
          <th style="width:120px">Line Total</th>
          <th style="width:120px">Net Weight</th>
          <th style="width:80px">Country</th>
          <th style="width:140px">Actions</th>
        </tr></thead></table>
      </div>
    </div>
    <div class="table-body-wrapper">
      <div class="table-body">
        <table><tbody id="tableBody"></tbody></table>
      </div>
    </div>
  </div>
</div>

<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  let allData = [];
  let currentInvoice = '';
  let invoiceOrder = [];
  let uploadedPdfName = '';
  let _nextFocusId = null;
  
  // Database storage
  let mankiDb = null;
  let htsCodesDb = null;
  let steelAlumDb = null;

  // ========================================
  // CONFIGURATION: Set your GitHub repository details here
  // ========================================
  const GITHUB_CONFIG = {
    // Replace with your GitHub username
    owner: 'YOUR_GITHUB_USERNAME',
    
    // Replace with your repository name
    repo: 'YOUR_REPO_NAME',
    
    // Replace with your branch name (usually 'main' or 'master')
    branch: 'main',
    
    // Path to the database file in your repository
    // If the file is in the root, just use the filename
    // If it's in a folder, use: 'folder/updated_manki_db.xlsx'
    filePath: 'updated_manki_db.xlsx'
  };

  // Auto-load database on page load
  window.addEventListener('DOMContentLoaded', function() {
    loadDatabaseFromGitHub();
  });

  async function loadDatabaseFromGitHub() {
    const { owner, repo, branch, filePath } = GITHUB_CONFIG;
    
    // Construct the raw GitHub URL
    const dbUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${filePath}`;
    
    document.getElementById('dbStatus').textContent = 'Loading database...';
    document.getElementById('dbStatus').className = 'db-status db-loading';
    document.getElementById('dbInfo').textContent = `Fetching from: ${dbUrl}`;

    try {
      // Fetch the Excel file from GitHub
      const response = await fetch(dbUrl);
      
      if (!response.ok) {
        throw new Error(`Failed to load database: ${response.status} ${response.statusText}`);
      }

      // Convert to array buffer
      const arrayBuffer = await response.arrayBuffer();
      const data = new Uint8Array(arrayBuffer);
      const workbook = XLSX.read(data, {type:'array'});
      
      // Load UPDATED_MANKI_DB sheet
      if(workbook.SheetNames.includes('UPDATED_MANKI_DB')){
        mankiDb = XLSX.utils.sheet_to_json(workbook.Sheets['UPDATED_MANKI_DB']);
      } else {
        throw new Error('UPDATED_MANKI_DB sheet not found in database');
      }
      
      // Load manki_hts_codes_with_uom sheet
      if(workbook.SheetNames.includes('manki_hts_codes_with_uom')){
        htsCodesDb = XLSX.utils.sheet_to_json(workbook.Sheets['manki_hts_codes_with_uom']);
      } else {
        throw new Error('manki_hts_codes_with_uom sheet not found in database');
      }
      
      // Load Sheet1 (Steel/Aluminum mappings)
      if(workbook.SheetNames.includes('Sheet1')){
        steelAlumDb = XLSX.utils.sheet_to_json(workbook.Sheets['Sheet1']);
      } else {
        throw new Error('Sheet1 not found in database');
      }
      
      // Success!
      document.getElementById('dbStatus').textContent = `Database loaded âœ“ (${mankiDb.length} parts, ${htsCodesDb.length} HTS codes, ${steelAlumDb.length} mappings)`;
      document.getElementById('dbStatus').className = 'db-status db-loaded';
      document.getElementById('dbInfo').textContent = `Last loaded: ${new Date().toLocaleString()} | Source: GitHub Repository`;
      
      console.log('Database loaded successfully:', {
        parts: mankiDb.length,
        htsCodes: htsCodesDb.length,
        steelAlum: steelAlumDb.length
      });
      
    } catch(err) {
      console.error('Error loading database:', err);
      document.getElementById('dbStatus').textContent = 'Database load failed âœ—';
      document.getElementById('dbStatus').className = 'db-status db-error';
      document.getElementById('dbInfo').innerHTML = `
        <strong>Error:</strong> ${err.message}<br>
        <strong>Fix:</strong> Update GITHUB_CONFIG in the HTML file with your repository details.<br>
        <strong>Expected URL:</strong> ${dbUrl}
      `;
    }
  }

  // PDF Upload handlers
  const uploadBox = document.getElementById('uploadBox');
  const fileInput = document.getElementById('fileInput');

  uploadBox.addEventListener('click', () => fileInput.click());
  uploadBox.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadBox.classList.add('dragover');
  });
  uploadBox.addEventListener('dragleave', () => uploadBox.classList.remove('dragover'));
  uploadBox.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadBox.classList.remove('dragover');
    if(e.dataTransfer.files.length) {
      fileInput.files = e.dataTransfer.files;
      handleFileUpload(e.dataTransfer.files[0]);
    }
  });
  fileInput.addEventListener('change', (e) => {
    if(e.target.files.length) handleFileUpload(e.target.files[0]);
  });

  async function handleFileUpload(file){
    if(!file || file.type !== 'application/pdf'){
      showAlert('Please upload a valid PDF file', 'error');
      return;
    }
    uploadedPdfName = file.name.replace(/\.pdf$/i,'');
    document.getElementById('uploadSection').style.display='none';
    document.getElementById('loading').style.display='block';
    try {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({data:arrayBuffer}).promise;
      await parsePDF(pdf);
      showAlert('PDF parsed successfully!','success');
    } catch(err){
      showAlert('Error parsing PDF: '+err.message,'error');
      document.getElementById('uploadSection').style.display='block';
    } finally {
      document.getElementById('loading').style.display='none';
    }
  }

  async function parsePDF(pdf){
    allData = [];
    invoiceOrder = [];
    const numPages = pdf.numPages;
    let extractedData = [];

    for(let pageNum=1; pageNum<=numPages; pageNum++){
      const page = await pdf.getPage(pageNum);
      const textContent = await page.getTextContent();
      const pageText = textContent.items.map(item=>item.str).join(' ');
      extractedData.push({pageNum, textContent: textContent.items, pageText});
    }

    const invoices = groupIntoInvoices(extractedData);
    invoices.forEach(inv=>{
      const invNum = inv.invoiceNumber;
      if(!invoiceOrder.includes(invNum)) invoiceOrder.push(invNum);
      inv.lineItems.forEach(li=>{
        allData.push({
          invoice_number: invNum,
          invoice_date: inv.invoiceDate || '',
          invoice_total: inv.invoiceTotal || '',
          supplier: inv.supplier || '',
          position: li.position || '',
          part_number: li.partNumber || '',
          quantity: li.quantity || '',
          unit: li.unit || '',
          unit_price: li.unitPrice || '',
          line_total: li.lineTotal || '',
          net_weight: li.netWeight || '',
          country_of_origin: li.countryOfOrigin || ''
        });
      });
    });

    populateInvoiceDropdown();
    if(invoiceOrder.length>0){
      currentInvoice = invoiceOrder[0];
      document.getElementById('invoiceSelect').value = currentInvoice;
      loadInvoiceData();
    }
    document.getElementById('controls').style.display='block';
  }

  function groupIntoInvoices(extractedData){
    const invoices = [];
    let currentInv = null;

    extractedData.forEach(pageData=>{
      const lines = pageData.pageText.split(/\n+/);
      let invNum = null, invDate = null, invTotal = null, supplier = null;

      // Extract invoice metadata
      lines.forEach(line=>{
        if(/Invoice\s*#?\s*[:\-]?\s*(\S+)/i.test(line)){
          invNum = line.match(/Invoice\s*#?\s*[:\-]?\s*(\S+)/i)[1];
        }
        if(/Date\s*[:\-]?\s*(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/i.test(line)){
          invDate = line.match(/Date\s*[:\-]?\s*(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/i)[1];
        }
        if(/Total\s*[:\-]?\s*\$?\s*([\d,]+\.?\d*)/i.test(line)){
          invTotal = line.match(/Total\s*[:\-]?\s*\$?\s*([\d,]+\.?\d*)/i)[1].replace(/,/g,'');
        }
        if(/Supplier\s*[:\-]?\s*(.+?)(?=\s{2,}|$)/i.test(line)){
          supplier = line.match(/Supplier\s*[:\-]?\s*(.+?)(?=\s{2,}|$)/i)[1].trim();
        }
      });

      if(invNum && (!currentInv || currentInv.invoiceNumber !== invNum)){
        if(currentInv) invoices.push(currentInv);
        currentInv = {
          invoiceNumber: invNum,
          invoiceDate: invDate || '',
          invoiceTotal: invTotal || '',
          supplier: supplier || '',
          lineItems: []
        };
      }

      // Parse line items
      const itemPattern = /(\d+)\s+([\w\.\-]+)\s+([\d,]+\.?\d*)\s+(\w+)\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)\s+(\w+)/g;
      let match;
      while((match = itemPattern.exec(pageData.pageText)) !== null){
        if(currentInv){
          currentInv.lineItems.push({
            position: match[1],
            partNumber: match[2],
            quantity: match[3].replace(/,/g,''),
            unit: match[4],
            unitPrice: match[5].replace(/,/g,''),
            lineTotal: match[6].replace(/,/g,''),
            netWeight: match[7].replace(/,/g,''),
            countryOfOrigin: match[8]
          });
        }
      }
    });

    if(currentInv) invoices.push(currentInv);
    return invoices;
  }

  function populateInvoiceDropdown(){
    const sel = document.getElementById('invoiceSelect');
    sel.innerHTML = '<option value="">Select an invoice...</option>';
    invoiceOrder.forEach(inv=>{
      const opt = document.createElement('option');
      opt.value = inv;
      opt.textContent = `Invoice ${inv}`;
      sel.appendChild(opt);
    });
    sel.addEventListener('change', function(){
      currentInvoice = this.value;
      if(currentInvoice) loadInvoiceData();
    });
  }

  function showAlert(message, type){
    const alertDiv = document.getElementById('alert');
    alertDiv.textContent = message;
    alertDiv.style.cssText = `display:block;padding:15px;margin:20px;border-radius:4px;background:${type==='success'?'#d4edda':'#f8d7da'};color:${type==='success'?'#155724':'#721c24'}`;
    setTimeout(()=>alertDiv.style.display='none', 3000);
  }

  function parseFloatSafe(val){ const n=parseFloat(String(val||'').replace(/[^\d.-]/g,'')); return isNaN(n)?0:n; }

  function loadInvoiceData(){
    const items = allData.filter(d=>d.invoice_number===currentInvoice);
    if(!items.length) return;

    items.sort((a,b)=>{
      const parsePos=p=>{ const m=String(p||'').match(/^(\d+)([A-Z]?)$/i); if(!m) return {n:999999,s:'Z'}; return {n:parseInt(m[1],10), s:(m[2]||'')}; };
      const A=parsePos(a.position), B=parsePos(b.position);
      if(A.n!==B.n) return A.n-B.n;
      return A.s.localeCompare(B.s);
    });

    document.getElementById('statInvoice').textContent=currentInvoice;
    document.getElementById('statDate').value=items[0].invoice_date||'';
    document.getElementById('statSupplier').value=items[0].supplier||'';
    document.getElementById('statTotal').value=items[0].invoice_total||'';
    document.getElementById('statItems').textContent=String(items.length);

    const tbody=document.getElementById('tableBody');
    tbody.innerHTML='';
    items.forEach((row, idx)=>{ tbody.appendChild(renderRow(row, idx)); });

    document.getElementById('stats').style.display='grid';
    document.getElementById('tableContainer').style.display='block';

    recomputeStats();
  }

  function renderRow(row, idx){
    const tr=document.createElement('tr');

    function cellInput(val, key, readonly=false){
      const td=document.createElement('td');
      const inp=document.createElement('input');
      inp.value = (val==null?'':String(val));
      if(readonly) inp.classList.add('readonly');
      inp.readOnly = readonly;
      const id = `${key}-${idx}-${Math.random().toString(36).slice(2,7)}`;
      inp.id = id; if(_nextFocusId===id){ setTimeout(()=>inp.focus(),0); _nextFocusId=null; }
      inp.addEventListener('change',()=>{ updateCell(idx,key,inp.value); });
      td.appendChild(inp); return td;
    }

    function btn(txt, cls, handler){ const b=document.createElement('button'); b.textContent=txt; b.className=cls; b.onclick=handler; return b; }

    tr.appendChild(cellInput(row.position,'position'));
    tr.appendChild(cellInput(row.part_number,'part_number'));
    tr.appendChild(cellInput(row.quantity,'quantity'));
    tr.appendChild(cellInput(row.unit,'unit'));
    tr.appendChild(cellInput(row.unit_price,'unit_price'));
    tr.appendChild(cellInput(row.line_total,'line_total'));
    tr.appendChild(cellInput(row.net_weight,'net_weight'));
    tr.appendChild(cellInput(row.country_of_origin,'country_of_origin'));

    const actTd=document.createElement('td'); actTd.className='actions';
    actTd.appendChild(btn('âž• Below','btn-info',()=>addRowBelow(idx)));
    actTd.appendChild(btn('ðŸ—‘ï¸','btn-danger',()=>deleteRow(idx)));
    tr.appendChild(actTd);

    return tr;
  }

  function updateCell(rowIndex, key, value){
    const items = allData.filter(d=>d.invoice_number===currentInvoice);
    const sortedIdxMap = items
      .map((row, idx)=>({row, idx}))
      .sort((a,b)=>{
        const parsePos=p=>{ const m=String(p.row.position||'').match(/^(\d+)([A-Z]?)$/i); if(!m) return {n:999999,s:'Z'}; return {n:parseInt(m[1],10), s:(m[2]||'')}; };
        const A=parsePos(a.row.position), B=parsePos(b.row.position);
        if(A.n!==B.n) return A.n-B.n; return A.s.localeCompare(B.s);
      })
      .map(x=>x.idx);

    const realIdx = sortedIdxMap[rowIndex];
    const recs = allData.filter(d=>d.invoice_number===currentInvoice);
    recs[realIdx][key]=value;
    loadInvoiceData();
  }

  function addRowBelow(rowIndex){
    const items = allData.filter(d=>d.invoice_number===currentInvoice);
    items.sort((a,b)=>{
      const parsePos=p=>{ const m=String(p||'').match(/^(\d+)([A-Z]?)$/i); if(!m) return {n:999999,s:'Z'}; return {n:parseInt(m[1],10), s:(m[2]||'')}; };
      const A=parsePos(a.position), B=parsePos(b.position);
      if(A.n!==B.n) return A.n-B.n; return A.s.localeCompare(B.s);
    });
    const base = items[rowIndex];
    const insertPos = `${String(base.position).replace(/[^0-9].*$/,'')}${String.fromCharCode(65 + Math.floor(Math.random()*26))}`;
    const newRow = { invoice_number:currentInvoice, invoice_date:base.invoice_date, invoice_total:base.invoice_total, supplier:base.supplier, position:insertPos, part_number:'', quantity:'', unit:'', unit_price:'', line_total:'', net_weight:'', country_of_origin:base.country_of_origin };
    const firstIdx = allData.findIndex(d=>d===base);
    allData.splice(firstIdx+1,0,newRow);
    loadInvoiceData();
  }

  function deleteRow(rowIndex){
    const items = allData.filter(d=>d.invoice_number===currentInvoice);
    items.sort((a,b)=>{
      const parsePos=p=>{ const m=String(p||'').match(/^(\d+)([A-Z]?)$/i); if(!m) return {n:999999,s:'Z'}; return {n:parseInt(m[1],10), s:(m[2]||'')}; };
      const A=parsePos(a.position), B=parsePos(b.position);
      if(A.n!==B.n) return A.n-B.n; return A.s.localeCompare(B.s);
    });
    const base = items[rowIndex];
    const idx = allData.findIndex(d=> d===base);
    if(idx>=0){ allData.splice(idx,1); loadInvoiceData(); }
  }

  function addBlankRowForCurrent(){
    if(!currentInvoice){ showAlert('Select an invoice first','error'); return; }
    const items = allData.filter(d=>d.invoice_number===currentInvoice);
    const meta = items[0]||{};
    const newRow = { invoice_number:currentInvoice, invoice_date:meta.invoice_date||'', invoice_total:meta.invoice_total||'', supplier:meta.supplier||'', position:'', part_number:'', quantity:'', unit:'', unit_price:'', line_total:'', net_weight:'', country_of_origin:meta.country_of_origin||'' };
    allData.push(newRow); loadInvoiceData();
  }

  function updateInvoiceField(field, value){
    allData.forEach(d=>{ if(d.invoice_number===currentInvoice){ d[field]=value; }});
  }
  function updateInvoiceTotal(value){ updateInvoiceField('invoice_total', value); recomputeStats(); }

  function recomputeStats(){
    const items = allData.filter(d=>d.invoice_number===currentInvoice);
    const sum = items.reduce((acc,r)=> acc + (parseFloatSafe(r.line_total)||0), 0);
    const invTotal = parseFloatSafe(items[0]?.invoice_total);
    const diff = (isNaN(invTotal)?0:invTotal) - sum;
    document.getElementById('statSum').textContent = '$'+sum.toFixed(2);
    document.getElementById('statDiff').textContent = '$'+diff.toFixed(2);
  }

  function resetUpload(){ location.reload(); }

  function exportToExcel(){
    if(!allData.length){ showAlert('No data to export','error'); return; }
    const wb = XLSX.utils.book_new();
    const byInv = {};
    allData.forEach(r=>{ if(!byInv[r.invoice_number]) byInv[r.invoice_number]=[]; byInv[r.invoice_number].push(r); });
    Object.keys(byInv).forEach(inv=>{
      const rows = byInv[inv].slice().sort((a,b)=>{
        const parsePos=p=>{ const m=String(p||'').match(/^(\d+)([A-Z]?)$/i); if(!m) return {n:999999,s:'Z'}; return {n:parseInt(m[1],10), s:(m[2]||'')}; };
        const A=parsePos(a.position), B=parsePos(b.position);
        if(A.n!==B.n) return A.n-B.n; return A.s.localeCompare(B.s);
      });
      const header = [
        ['Invoice', inv],
        ['Date', rows[0]?.invoice_date || ''],
        ['Supplier', rows[0]?.supplier || ''],
        ['Invoice Total', rows[0]?.invoice_total || ''],
        [],
        ['Pos','Part Number','Quantity','Unit','Unit Price','Line Total','Net Weight','Country']
      ];
      const body = rows.map(r=>[
        r.position||'', r.part_number||'', r.quantity||'', r.unit||'', r.unit_price||'', r.line_total||'', r.net_weight||'', r.country_of_origin||''
      ]);
      const ws = XLSX.utils.aoa_to_sheet([...header, ...body]);
      XLSX.utils.book_append_sheet(wb, ws, `INV_${String(inv).slice(-10)}`);
    });
    const out = XLSX.write(wb, {type:'array', bookType:'xlsx'});
    const blob = new Blob([out], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = (uploadedPdfName?uploadedPdfName+'_':'')+'parsed_invoices.xlsx';
    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  }

  // Extract base part number (4-5 digits)
  function extractBasePartNumber(fullPartNum){
    const match = String(fullPartNum).match(/^(\d{4,5})/);
    return match ? match[1] : '';
  }

  // Look up tariffs for a part number
  function lookupTariffs(basePartNum){
    if(!mankiDb) return [];
    const part = mankiDb.find(row => String(row['PRIMARY PART NUM']) === basePartNum);
    if(!part) return [];
    
    const tariffs = [];
    for(let i=0; i<=5; i++){
      const col = i===0 ? 'TARIFF NUM' : `TARIFF NUM_${i}`;
      if(part[col]){
        const tariffStr = String(part[col]).replace(/\.0$/, '');
        tariffs.push(tariffStr);
      }
    }
    return tariffs;
  }

  // Look up UOM for HTS code
  function lookupHtsUom(htsCode){
    if(!htsCodesDb) return {uom1: '', uom2: ''};
    const hts = htsCodesDb.find(row => String(row['HTS Code']) === String(htsCode));
    if(!hts) return {uom1: '', uom2: ''};
    return {
      uom1: hts['UOM1'] || '',
      uom2: hts['UOM2'] || ''
    };
  }

  // Determine Steel/Aluminum part number
  function getSteelAlumPartNumber(tariff, type){
    if(!steelAlumDb) return type === 'Steel' ? 'STEEL GENERIC' : 'ALUM GENERIC';
    
    const mapping = steelAlumDb.find(row => {
      const tariffNum = String(row['Tariff']).replace(/\.0$/, '');
      return tariffNum === String(tariff);
    });
    
    if(mapping){
      return type === 'Steel' ? mapping['Steel'] : mapping['Aluminum'];
    }
    
    return type === 'Steel' ? 'STEEL GENERIC' : 'ALUM GENERIC';
  }

  function exportToDescartes(){
    if(!currentInvoice){ showAlert('Select an invoice first','error'); return; }
    if(!mankiDb || !htsCodesDb || !steelAlumDb){
      showAlert('Database not loaded. Please wait for it to load from GitHub.','error');
      return;
    }

    const items = allData.filter(d=>d.invoice_number===currentInvoice);
    items.sort((a,b)=>{
      const parsePos=p=>{ const m=String(p||'').match(/^(\d+)([A-Z]?)$/i); if(!m) return {n:999999,s:'Z'}; return {n:parseInt(m[1],10), s:(m[2]||'')}; };
      const A=parsePos(a.position), B=parsePos(b.position);
      if(A.n!==B.n) return A.n-B.n; return A.s.localeCompare(B.s);
    });

    const exportRows = [];

    items.forEach(item => {
      const basePartNum = extractBasePartNumber(item.part_number);
      const tariffs = lookupTariffs(basePartNum);
      
      // Create main row
      const row = {
        'InvoiceNumber': item.invoice_number,
        'InvoiceDate': item.invoice_date,
        'InvoiceTotal': item.invoice_total,
        'SupplierMID': '',
        'SupplierName': item.supplier,
        'BuyerPartNumber': basePartNum,
        'SupplierPartNumber': basePartNum,
        'Quantity': item.quantity,
        'UnitOfMeasure': item.unit,
        'Description': '',
        'UnitPrice': item.unit_price,
        'ItemTotal': item.line_total,
        'CurrencyCode': '',
        'ExchangeRate': '',
        'CountryOfOrigin': item.country_of_origin,
        'CountryOfExport': '',
        'DateOfExport': '',
        'PortOfLading': '',
        'RelatedParty': '',
        'PO_Number': '',
        'PO_Date': '',
        'GrossWeight': '',
        'GrossWeightUnit': '',
        'NetWeight': item.net_weight,
        'TariffNumber': '',
        'TariffDescription': '',
        'Quantity1': '',
        'UnitOfMeasure1': '',
        'Quantity2': '',
        'UnitOfMeasure2': '',
        'Quantity3': '',
        'UnitOfMeasure3': '',
        'PrimarySPI': '',
        'SecondarySPI': '',
        'DeliverTo': '',
        'SoldTo': '',
        'SellerMID': '',
        'ShipperMID': '',
        'EntryDate': '',
        'ArrivalDate': '',
        'Carrier': '',
        'Vessel': '',
        'Voyage': '',
        'PortOfEntry': '',
        'PortOfUnloading': '',
        'LocationCode': '',
        'TotalCharges': '',
        'BillOfLadingNumber': '',
        'Container': '',
        'SecondaryTariffNumber': '',
        'SecondaryTariffdescription': '',
        'Secondary Quantity1': '',
        'Secondaryunitofmeasure1': '',
        'secondaryquantity2': '',
        'secondaryunitofmeasure2': '',
        'secondaryquantity3': '',
        'secondaryunitofmeasure3': '',
        'secondaryvalue': '',
        'FTZStatus': '',
        'FTZPrivilegedDate\u00a0': '',
        'ThirdTariffNumber': '',
        'ThirdTariffDescription': '',
        'ThirdTariffQuantity1': '',
        'ThirdTariffUnitofMeasure1': '',
        'ThirdTariffQuantity2': '',
        'ThirdTariffUnitofMeasure2': '',
        'ThirdTariffQuantity3': '',
        'ThirdTariffUnitofMeasure3': '',
        'Third Value': '',
        '4TariffNumber': '',
        '4TariffDescription': '',
        '4TariffQuantity1': '',
        '4TariffUnitofMeasure1': '',
        '4TariffQuantity2': '',
        '4TariffUnitofMeasure2': '',
        '4TariffQuantity3': '',
        '4TariffUnitofMeasure3': '',
        '4 Value': '',
        '5TariffNumber': '',
        '5TariffDescription': '',
        '5TariffQuantity1': '',
        '5TariffUnitofMeasure1': '',
        '5TariffQuantity2': '',
        '5TariffUnitofMeasure2': '',
        '5TariffQuantity3': '',
        '5TariffUnitofMeasure3': '',
        '5 Value': '',
        '6TariffNumber': '',
        '6TariffDescription': '',
        '6TariffQuantity1': '',
        '6TariffUnitofMeasure1': '',
        '6TariffQuantity2': '',
        '6TariffUnitofMeasure2': '',
        '6TariffQuantity3': '',
        '6TariffUnitofMeasure3': '',
        '6 Value': '',
        '7TariffNumber': '',
        '7TariffDescription': '',
        '7TariffQuantity1': '',
        '7TariffUnitofMeasure1': '',
        '7TariffQuantity2': '',
        '7TariffUnitofMeasure2': '',
        '7TariffQuantity3': '',
        '7TariffUnitofMeasure3': '',
        '7 Value': '',
        '8TariffNumber': '',
        '8TariffDescription': '',
        '8TariffQuantity1': '',
        '8TariffUnitofMeasure1': '',
        '8TariffQuantity2': '',
        '8TariffUnitofMeasure2': '',
        '8TariffQuantity3': '',
        '8TariffUnitofMeasure3': '',
        '8 Value': ''
      };

      // Populate tariffs
      const tariffFields = ['TariffNumber', 'SecondaryTariffNumber', 'ThirdTariffNumber', '4TariffNumber', '5TariffNumber'];
      
      tariffs.forEach((tariff, idx) => {
        if(idx < tariffFields.length){
          row[tariffFields[idx]] = tariff;
          
          // Check if tariff starts with 98 or 99
          const startsWithExempt = tariff.startsWith('98') || tariff.startsWith('99');
          
          if(!startsWithExempt){
            // Look up UOM from HTS codes
            const uomInfo = lookupHtsUom(tariff);
            
            if(idx === 0){
              // Primary tariff
              row['Quantity1'] = item.net_weight;
              row['UnitOfMeasure1'] = uomInfo.uom1;
              if(uomInfo.uom2){
                row['Quantity2'] = item.net_weight;
                row['UnitOfMeasure2'] = uomInfo.uom2;
              }
            } else if(idx === 1){
              // Secondary tariff
              row['Secondary Quantity1'] = item.net_weight;
              row['Secondaryunitofmeasure1'] = uomInfo.uom1;
              if(uomInfo.uom2){
                row['secondaryquantity2'] = item.net_weight;
                row['secondaryunitofmeasure2'] = uomInfo.uom2;
              }
            } else if(idx === 2){
              // Third tariff
              row['ThirdTariffQuantity1'] = item.net_weight;
              row['ThirdTariffUnitofMeasure1'] = uomInfo.uom1;
              if(uomInfo.uom2){
                row['ThirdTariffQuantity2'] = item.net_weight;
                row['ThirdTariffUnitofMeasure2'] = uomInfo.uom2;
              }
            } else if(idx === 3){
              // 4th tariff
              row['4TariffQuantity1'] = item.net_weight;
              row['4TariffUnitofMeasure1'] = uomInfo.uom1;
              if(uomInfo.uom2){
                row['4TariffQuantity2'] = item.net_weight;
                row['4TariffUnitofMeasure2'] = uomInfo.uom2;
              }
            } else if(idx === 4){
              // 5th tariff
              row['5TariffQuantity1'] = item.net_weight;
              row['5TariffUnitofMeasure1'] = uomInfo.uom1;
              if(uomInfo.uom2){
                row['5TariffQuantity2'] = item.net_weight;
                row['5TariffUnitofMeasure2'] = uomInfo.uom2;
              }
            }
          }
        }
      });

      exportRows.push(row);

      // Add Steel line if needed
      if(tariffs.length > 0 && !tariffs[0].startsWith('98') && !tariffs[0].startsWith('99')){
        const steelPartNum = getSteelAlumPartNumber(tariffs[0], 'Steel');
        const steelRow = {...row};
        steelRow['BuyerPartNumber'] = steelPartNum;
        steelRow['SupplierPartNumber'] = steelPartNum;
        steelRow['UnitOfMeasure'] = 'KG';
        exportRows.push(steelRow);
      }
    });

    // Create Excel workbook
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(exportRows);
    XLSX.utils.book_append_sheet(wb, ws, 'Descartes Export');
    
    const out = XLSX.write(wb, {type:'array', bookType:'xlsx'});
    const blob = new Blob([out], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = (uploadedPdfName?uploadedPdfName+'_':'')+'descartes_export.xlsx';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showAlert('Descartes template exported successfully!', 'success');
  }
</script>
</body>
</html>
