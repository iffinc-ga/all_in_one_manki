<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invoice PDF Parser & Editor â€” Steel/Aluminum Sublines</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Arial, sans-serif;background:#f5f7fa;padding:20px}
    .container{max-width:1800px;margin:0 auto;background:#fff;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:30px;border-radius:8px 8px 0 0}
    .header h1{margin-bottom:8px}
    .upload-section{padding:40px;text-align:center}
    .upload-box{border:3px dashed #cbd5e0;border-radius:8px;padding:40px;cursor:pointer;transition:.3s}
    .upload-box:hover{border-color:#667eea;background:#f7fafc}
    .upload-box.dragover{border-color:#667eea;background:#e6f0ff}
    #fileInput{display:none}
    .loading{padding:40px;text-align:center;display:none}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 20px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .controls{padding:20px;background:#f8f9fa;border-bottom:1px solid #dee2e6;display:none}
    .controls select{padding:10px;border:1px solid #ced4da;border-radius:4px;font-size:14px;min-width:400px;margin-right:10px}
    .controls button{padding:10px 20px;border:none;border-radius:4px;font-weight:600;cursor:pointer;margin-right:10px}
    .btn-success{background:#28a745;color:#fff}.btn-success:hover{background:#218838}
    .btn-primary{background:#007bff;color:#fff}.btn-primary:hover{background:#0056b3}
    .btn-danger{background:#dc3545;color:#fff}.btn-danger:hover{background:#c82333}
    .btn-info{background:#17a2b8;color:#fff}.btn-info:hover{background:#138496}
    .stats{padding:20px;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;background:#fff3cd;display:none}
    .stat{padding:15px;background:#fff;border-radius:4px;border-left:4px solid #ffc107}
    .stat-label{font-size:11px;color:#6c757d;text-transform:uppercase;margin-bottom:5px}
    .stat-value{font-size:20px;font-weight:700}
    .stat-value.error{color:#dc3545}.stat-value.success{color:#28a745}
    .stat input{width:100%;padding:6px;border:1px solid #ced4da;border-radius:3px;font-size:16px;font-weight:bold}
    .stat.editable{border-left-color:#007bff}
    .table-container{padding:20px;display:none}
    .table-header-wrapper{background:#343a40;overflow:auto}
    .table-header-wrapper::-webkit-scrollbar{display:none}
    .table-header-wrapper{scrollbar-width:none}
    .table-header{min-width:1200px}
    .table-header table{width:100%;border-collapse:collapse}
    .table-header th{padding:10px;color:#fff;border-right:1px solid #495057;font-size:12px;white-space:nowrap}
    .table-header .pos{width:80px}
    .table-header .actions{width:160px}
    .table-body{max-height:520px;overflow:auto}
    .table-body table{width:100%;border-collapse:collapse}
    .table-body td{padding:8px;border-bottom:1px solid #e9ecef;font-size:12px;vertical-align:top}
    .table-body tr:nth-child(even){background:#f8f9fa}
    .row-controls button{padding:6px 10px;font-size:12px}
    .alert{margin:20px;border-radius:6px;padding:12px}
    .alert.error{background:#fdecea;color:#b71c1c;border:1px solid #f5c2c7}
    .alert.success{background:#e7f5ff;color:#0c5460;border:1px solid #b6effb}
    .db-section{padding:12px 20px;background:#f0f4ff;border-bottom:1px solid #dbe4ff}
    .db-status{display:inline-block;margin-left:8px;font-weight:700}
    .db-status.db-loading{color:#6c757d}
    .db-status.db-loaded{color:#198754}
    .db-status.db-error{color:#dc3545}
    .db-info{font-size:12px;color:#6c757d;margin-top:6px}
    .footer{padding:16px;color:#6c757d;font-size:12px;text-align:center}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Invoice PDF Parser & Editor</h1>
      <p>Extract lines from PDF invoices, add steel/aluminum sublines, and export to Excel/Descartes. Database lookups (tariffs/parts) are optional and can be loaded from GitHub or a local .xlsx.</p>
    </div>

    <div class="db-section" id="dbSection">
      <strong>Database Status:</strong>
      <span class="db-status db-loading" id="dbStatus">Loading database from repository...</span>
      <div class="db-info" id="dbInfo">Fetching updated_manki_db.xlsx from GitHub...</div>
      <div class="db-actions" id="dbActions" style="margin-top:8px;">
        <button id="dbRetryBtn" class="btn-info">Retry GitHub</button>
        <button id="dbUploadBtn" class="btn-primary">Upload DB (.xlsx)</button>
        <button id="dbSkipBtn" class="btn-danger">Skip database</button>
        <input type="file" id="dbFileInput" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" style="display:none" />
      </div>
    </div>

    <div class="upload-section" id="uploadSection">
      <div class="upload-box" id="uploadBox">
        <h2>ðŸ“¤ Upload PDF Invoice</h2>
        <p style="margin-top:10px;color:#6c757d">Click or drag & drop your PDF file here</p>
        <input type="file" id="fileInput" accept=".pdf,application/pdf" />
      </div>
    </div>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div><strong>Processing PDF...</strong></div>
    </div>

    <div class="alert" id="alert" style="display:none"></div>

    <div class="controls" id="controls">
      <select id="invoiceSelect"><option value="">Select an invoice...</option></select>
      <button id="exportExcel" class="btn-success">Export to Excel</button>
      <button id="exportDescartes" class="btn-primary">Export Descartes CSV</button>
      <button id="addLineBelowBtn" class="btn-info">Add Line Below (Selected)</button>
    </div>

    <div class="stats" id="stats">
      <div class="stat">
        <div class="stat-label">Invoice Total (from PDF)</div>
        <div class="stat-value" id="invoiceTotalDisplay">â€”</div>
      </div>
      <div class="stat">
        <div class="stat-label">Sum of Line Totals (excl. S/A)</div>
        <div class="stat-value" id="sumLineTotalsDisplay">â€”</div>
      </div>
      <div class="stat editable">
        <div class="stat-label">Override Invoice Total</div>
        <input id="invoiceTotalOverride" type="text" placeholder="e.g. 1234.56" />
      </div>
      <div class="stat">
        <div class="stat-label">Difference</div>
        <div class="stat-value" id="differenceDisplay">â€”</div>
      </div>
    </div>

    <div class="table-container" id="tableContainer">
      <div class="table-header-wrapper">
        <div class="table-header">
          <table>
            <thead>
              <tr>
                <th class="pos">POS</th>
                <th>Part Number</th>
                <th>Description</th>
                <th>Qty</th>
                <th>Unit</th>
                <th>Unit Price</th>
                <th>Line Total</th>
                <th>Country</th>
                <th>Tariff</th>
                <th>Notes</th>
                <th class="actions">Actions</th>
              </tr>
            </thead>
          </table>
        </div>
      </div>
      <div class="table-body" id="tableBody">
        <table>
          <tbody id="tableRows"></tbody>
        </table>
      </div>
    </div>

    <div class="footer">Â© IFF USA â€” Invoice tools</div>
  </div>

<script>
// ========================================
// Minimal helpers for alerts & formatting
// ========================================
function showAlert(msg, type='error'){const a=document.getElementById('alert');a.textContent=msg;a.className='alert '+type;a.style.display='block';setTimeout(()=>a.style.display='none',6000)}
function parseFloatSafe(v){const n=String(v||'').replace(/[^0-9.\-]/g,'');return n?parseFloat(n):0}
function fmt(n){return (isFinite(n)?n:0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}

// ========================================
// GLOBAL STATE
// ========================================
let parsedInvoices=[]; // [{invoice_number, lines:[...] , totals:{invoice_total}}]
let activeInvoiceIdx=-1;

// Database storage
let mankiDb=null;      // UPDATED_MANKI_DB
let htsCodesDb=null;   // manki_hts_codes_with_uom
let steelAlumDb=null;  // Sheet1 mapping

// CONFIGURATION: Set your GitHub repository details here
const GITHUB_CONFIG = {
  owner: 'iffinc-ga',               // Your GitHub username
  repo: 'all_in_one_manki',         // Your repository name
  branch: 'main',                   // Branch name
  filePath: 'updated_manki_db.xlsx' // Path to database file in repo
};

// Auto-load database when page loads
window.addEventListener('DOMContentLoaded', function() {
  loadDatabaseFromGitHub();
});

// ========================================
// GitHub load with timeout + Local fallback
// ========================================
async function loadDatabaseFromGitHub() {
  const { owner, repo, branch, filePath } = GITHUB_CONFIG;
  const dbUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${filePath}`;
  const status = document.getElementById('dbStatus');
  const info = document.getElementById('dbInfo');

  status.textContent = 'Loading database...';
  status.className = 'db-status db-loading';
  info.textContent = `Fetching from: ${dbUrl}`;

  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 12000); // 12s timeout

  try {
    const response = await fetch(dbUrl, { signal: controller.signal });
    if (!response.ok) throw new Error(`HTTP ${response.status} ${response.statusText}`);
    const arrayBuffer = await response.arrayBuffer();
    const workbook = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });
    ingestDatabaseWorkbook(workbook, 'GitHub Repository');
  } catch (err) {
    console.error('Database load error:', err);
    status.textContent = 'Database load failed âœ—';
    status.className = 'db-status db-error';
    info.innerHTML = `<strong>Error:</strong> ${err.name === 'AbortError' ? 'Timed out fetching GitHub file' : err.message}.` +
                     `<br><strong>Fix:</strong> Check repo/path/network or use "Upload DB" / "Skip database".`;
  } finally {
    clearTimeout(timeoutId);
  }
}

// Helpers: ingest workbook + local upload/skip/retry controls
function ingestDatabaseWorkbook(workbook, sourceLabel) {
  const status = document.getElementById('dbStatus');
  const info = document.getElementById('dbInfo');

  if (workbook.SheetNames.includes('UPDATED_MANKI_DB')) {
    mankiDb = XLSX.utils.sheet_to_json(workbook.Sheets['UPDATED_MANKI_DB']);
  } else {
    throw new Error('UPDATED_MANKI_DB sheet not found');
  }
  if (workbook.SheetNames.includes('manki_hts_codes_with_uom')) {
    htsCodesDb = XLSX.utils.sheet_to_json(workbook.Sheets['manki_hts_codes_with_uom']);
  } else {
    throw new Error('manki_hts_codes_with_uom sheet not found');
  }
  if (workbook.SheetNames.includes('Sheet1')) {
    steelAlumDb = XLSX.utils.sheet_to_json(workbook.Sheets['Sheet1']);
  } else {
    throw new Error('Sheet1 not found');
  }

  status.textContent = `Database loaded âœ“ (${mankiDb.length} parts, ${htsCodesDb.length} HTS, ${steelAlumDb.length} mappings)`;
  status.className = 'db-status db-loaded';
  info.textContent = `Loaded: ${new Date().toLocaleString()} | Source: ${sourceLabel}`;
}

function wireDbControls() {
  const retryBtn = document.getElementById('dbRetryBtn');
  const uploadBtn = document.getElementById('dbUploadBtn');
  const skipBtn = document.getElementById('dbSkipBtn');
  const fileInput = document.getElementById('dbFileInput');
  const status = document.getElementById('dbStatus');
  const info = document.getElementById('dbInfo');

  if (retryBtn) retryBtn.onclick = () => loadDatabaseFromGitHub();
  if (uploadBtn) uploadBtn.onclick = () => fileInput && fileInput.click();
  if (fileInput) fileInput.onchange = async (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    status.textContent = 'Reading local .xlsx...';
    status.className = 'db-status db-loading';
    info.textContent = `Local file: ${file.name}`;
    try {
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(new Uint8Array(buf), { type: 'array' });
      ingestDatabaseWorkbook(wb, `Local file: ${file.name}`);
    } catch (err) {
      console.error(err);
      status.textContent = 'Local DB load failed âœ—';
      status.className = 'db-status db-error';
      info.innerHTML = `<strong>Error:</strong> ${err.message}`;
    } finally {
      e.target.value = '';
    }
  };
  if (skipBtn) skipBtn.onclick = () => {
    status.textContent = 'Database skipped';
    status.className = 'db-status db-error';
    info.textContent = 'You can still parse PDFs and export. Tariff/part lookups may be limited.';
  };
}

// Wire controls
window.addEventListener('DOMContentLoaded', () => { wireDbControls(); });

// ========================================
// PDF ingest (placeholder of your existing parser)
// ========================================
const fileInput=document.getElementById('fileInput');
const uploadBox=document.getElementById('uploadBox');
const loading=document.getElementById('loading');
const controls=document.getElementById('controls');
const stats=document.getElementById('stats');
const tableContainer=document.getElementById('tableContainer');
const invoiceSelect=document.getElementById('invoiceSelect');

uploadBox.addEventListener('click',()=>fileInput.click());
uploadBox.addEventListener('dragover',e=>{e.preventDefault();uploadBox.classList.add('dragover')});
uploadBox.addEventListener('dragleave',()=>uploadBox.classList.remove('dragover'));
uploadBox.addEventListener('drop',e=>{e.preventDefault();uploadBox.classList.remove('dragover');if(e.dataTransfer.files.length){fileInput.files=e.dataTransfer.files;fileInput.dispatchEvent(new Event('change'))}});

fileInput.addEventListener('change', async (e)=>{
  const file=e.target.files[0];
  if(!file) return;
  await parsePdf(file);
});

async function parsePdf(file){
  loading.style.display='block';
  try{
    const arrayBuf=await file.arrayBuffer();
    const pdf=await pdfjsLib.getDocument({data:arrayBuf}).promise;
    parsedInvoices=[{invoice_number:'DEMO-123', totals:{invoice_total:0}, lines:[
      {pos:'10', part:'12345.ABC', desc:'Sample item', qty:5, unit:'PCS', unit_price:10, line_total:50, country:'DE', tariff:'8302100000', notes:''}
    ]}];
    activeInvoiceIdx=0;
    renderInvoiceList();
    renderTable();
    recomputeStats();
    controls.style.display='block';
    stats.style.display='grid';
    tableContainer.style.display='block';
  }catch(err){
    console.error(err);showAlert('Failed to parse PDF: '+err.message,'error')
  }finally{loading.style.display='none'}
}

// ========================================
// Rendering + S/A subline logic (abbrev â€” keep your existing detailed logic)
// ========================================
function renderInvoiceList(){
  invoiceSelect.innerHTML='<option value="">Select an invoice...</option>';
  parsedInvoices.forEach((inv,idx)=>{
    const opt=document.createElement('option');
    opt.value=idx; opt.textContent=inv.invoice_number; invoiceSelect.appendChild(opt);
  });
  if (activeInvoiceIdx>=0) invoiceSelect.value=activeInvoiceIdx;
}

invoiceSelect.addEventListener('change',()=>{activeInvoiceIdx=parseInt(invoiceSelect.value||'-1',10);renderTable();recomputeStats();});

function renderTable(){
  const tbody=document.getElementById('tableRows');
  tbody.innerHTML='';
  if(activeInvoiceIdx<0) return;
  const inv=parsedInvoices[activeInvoiceIdx];
  inv.lines.forEach((line,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${line.pos||''}</td>
      <td contenteditable> ${line.part||''} </td>
      <td contenteditable> ${line.desc||''} </td>
      <td contenteditable> ${line.qty??''} </td>
      <td contenteditable> ${line.unit||''} </td>
      <td contenteditable> ${fmt(line.unit_price||0)} </td>
      <td contenteditable> ${fmt(line.line_total||0)} </td>
      <td contenteditable> ${line.country||''} </td>
      <td contenteditable> ${line.tariff||''} </td>
      <td contenteditable> ${line.notes||''} </td>
      <td class='row-controls'>
        <button class='btn-info' onclick='addLineBelow(${i})'>Add Below</button>
        <button class='btn-danger' onclick='deleteLine(${i})'>Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function addLineBelow(i){
  if(activeInvoiceIdx<0) return;
  const inv=parsedInvoices[activeInvoiceIdx];
  const base=inv.lines[i];
  const posNum=parseInt(String(base.pos||'0').replace(/\D/g,''),10)||0;
  const newLine={...base, pos: String(posNum+1).padStart(2,'0'), notes:'(added)'};
  inv.lines.splice(i+1,0,newLine);
  renderTable();
}
function deleteLine(i){
  if(activeInvoiceIdx<0) return; const inv=parsedInvoices[activeInvoiceIdx];
  inv.lines.splice(i,1); renderTable();
}

function recomputeStats(){
  if(activeInvoiceIdx<0) return; const inv=parsedInvoices[activeInvoiceIdx];
  const invoiceTotal=parseFloatSafe(inv.totals.invoice_total||0);
  const sumExcludingSA=inv.lines.filter(l=>!/^\s*[SA]/i.test(String(l.pos))).reduce((s,l)=>s+parseFloatSafe(l.line_total),0);
  document.getElementById('invoiceTotalDisplay').textContent=fmt(invoiceTotal);
  document.getElementById('sumLineTotalsDisplay').textContent=fmt(sumExcludingSA);
  document.getElementById('differenceDisplay').textContent=fmt(invoiceTotal - sumExcludingSA);
}

// ========================================
// Export (placeholders; keep your real implementations)
// ========================================
document.getElementById('exportExcel').addEventListener('click',()=>{
  showAlert('Excel export placeholder â€” wire to your existing export logic','success');
});

document.getElementById('exportDescartes').addEventListener('click',()=>{
  showAlert('Descartes export placeholder â€” wire to your existing CSV builder','success');
});
</script>
</body>
</html>
