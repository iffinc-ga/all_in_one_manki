const allItems = allData.filter(d=>d.invoice_number===currentInvoice);
const bases = allItems.filter(r=>/^\d+$/.test(String(r.position||'')));

bases.forEach(base=>{
  const partCore = getPartCore(base.part_number);
  const tariffs  = partTariffsMap[partCore] || [];
  const [t1,t2,t3,t4,t5] = [tariffs[0]||'',tariffs[1]||'',tariffs[2]||'',tariffs[3]||'',tariffs[4]||''];
  const u1 = htsUomMap[String(t2).replace(/[^0-9]/g,'')] || {};

  // --- Base line (unchanged) ---
  if(!aoa[outRow]) aoa[outRow]=[];
  setCell(aoa,outRow,col.InvoiceNumber, currentInvoice);
  setCell(aoa,outRow,col.InvoiceDate,   base.invoice_date||'');
  setCell(aoa,outRow,col.InvoiceTotal,  base.invoice_total||'');
  setCell(aoa,outRow,col.SupplierName,  base.supplier||'');
  setCell(aoa,outRow,col.BuyerPartNumber,    partCore);
  setCell(aoa,outRow,col.SupplierPartNumber, partCore);
  setCell(aoa,outRow,col.Quantity,       base.quantity||'');
  setCell(aoa,outRow,col.UnitOfMeasure,  base.unit||'');
  setCell(aoa,outRow,col.UnitPrice,      base.unit_price||'');
  setCell(aoa[outRow],outRow,col.ItemTotal,  base.line_total||'');  // ensure row exists then set
  setCell(aoa,outRow,col.CountryOfOrigin,base.country_of_origin||'');
  setCell(aoa,outRow,col.NetWeight,      base.net_weight||'');
  setCell(aoa,outRow,col.TariffNumber,          t1);
  setCell(aoa,outRow,col.SecondaryTariffNumber, t2);
  if(col.ThirdTariffNumber>=0)  setCell(aoa,outRow,col.ThirdTariffNumber,  t3);
  if(col.FourthTariffNumber>=0) setCell(aoa,outRow,col.FourthTariffNumber, t4);
  if(col.FifthTariffNumber>=0)  setCell(aoa,outRow,col.FifthTariffNumber,  t5);
  if(t1 && !startsWith98or99(t1)){
    setCell(aoa,outRow,col.Quantity1,      base.net_weight||base.quantity||'');
    setCell(aoa,outRow,col.UnitOfMeasure1, (htsUomMap[t1]||{}).uom1||'');
  }
  if(t2 && !startsWith98or99(t2)){
    setCell(aoa,outRow,col.SecondaryQuantity1,     (u1.uom1==='KG')? (base.net_weight||'') : (base.quantity||''));
    setCell(aoa,outRow,col.SecondaryUnitOfMeasure1, u1.uom1||'');
    setCell(aoa,outRow,col.SecondaryUnitOfMeasure2, u1.uom2||'');
  }
  outRow++;

  // --- Steel subline (POS e.g. "10S") ---
  const steel = allItems.find(x=>String(x.position)===String(base.position)+'S');
  if(steel && parseFloat(steel.line_total||0)>0){
    const mp = materialPartFor([t1,t2,t3,t4,t5], 'steel');  // from Sheet1 or GENERIC
    if(!aoa[outRow]) aoa[outRow]=[];
    setCell(aoa,outRow,col.InvoiceNumber, currentInvoice);
    setCell(aoa,outRow,col.InvoiceDate,   base.invoice_date||'');
    setCell(aoa,outRow,col.InvoiceTotal,  base.invoice_total||'');
    setCell(aoa,outRow,col.SupplierName,  (mp.supplier||base.supplier||'')); // supplier can come from Sheet1
    setCell(aoa,outRow,col.BuyerPartNumber,    mp.part);
    setCell(aoa,outRow,col.SupplierPartNumber, mp.part);
    setCell(aoa,outRow,col.Quantity,       steel.quantity||steel.net_weight||''); // from parsed S line
    setCell(aoa,outRow,col.UnitOfMeasure,  'KG');                                  // per rule
    setCell(aoa,outRow,col.UnitPrice,      '');
    setCell(aoa,outRow,col.ItemTotal,      steel.line_total||'');                  // parsed customs value
    setCell(aoa,outRow,col.CountryOfOrigin,base.country_of_origin||'');
    setCell(aoa,outRow,col.NetWeight,      steel.quantity||steel.net_weight||'');  // reflect KG qty
    // use same HTS columns as base (these S/A charges ride with the product)
    setCell(aoa,outRow,col.TariffNumber,          t1);
    setCell(aoa,outRow,col.SecondaryTariffNumber, t2);
    if(col.ThirdTariffNumber>=0)  setCell(aoa,outRow,col.ThirdTariffNumber,  t3);
    if(col.FourthTariffNumber>=0) setCell(aoa,outRow,col.FourthTariffNumber, t4);
    if(col.FifthTariffNumber>=0)  setCell(aoa,outRow,col.FifthTariffNumber,  t5);
    outRow++;
  }

  // --- Aluminum subline (POS e.g. "10A") ---
  const alum = allItems.find(x=>String(x.position)===String(base.position)+'A');
  if(alum && parseFloat(alum.line_total||0)>0){
    const mp = materialPartFor([t1,t2,t3,t4,t5], 'alum');  // from Sheet1 or GENERIC
    if(!aoa[outRow]) aoa[outRow]=[];
    setCell(aoa,outRow,col.InvoiceNumber, currentInvoice);
    setCell(aoa,outRow,col.InvoiceDate,   base.invoice_date||'');
    setCell(aoa,outRow,col.InvoiceTotal,  base.invoice_total||'');
    setCell(aoa,outRow,col.SupplierName,  (mp.supplier||base.supplier||'')); // supplier can come from Sheet1
    setCell(aoa,outRow,col.BuyerPartNumber,    mp.part);
    setCell(aoa,outRow,col.SupplierPartNumber, mp.part);
    setCell(aoa,outRow,col.Quantity,       alum.quantity||alum.net_weight||'');
    setCell(aoa,outRow,col.UnitOfMeasure,  'KG');
    setCell(aoa,outRow,col.UnitPrice,      '');
    setCell(aoa,outRow,col.ItemTotal,      alum.line_total||'');
    setCell(aoa,outRow,col.CountryOfOrigin,base.country_of_origin||'');
    setCell(aoa,outRow,col.NetWeight,      alum.quantity||alum.net_weight||'');
    setCell(aoa,outRow,col.TariffNumber,          t1);
    setCell(aoa,outRow,col.SecondaryTariffNumber, t2);
    if(col.ThirdTariffNumber>=0)  setCell(aoa,outRow,col.ThirdTariffNumber,  t3);
    if(col.FourthTariffNumber>=0) setCell(aoa,outRow,col.FourthTariffNumber, t4);
    if(col.FifthTariffNumber>=0)  setCell(aoa,outRow,col.FifthTariffNumber,  t5);
    outRow++;
  }
});
