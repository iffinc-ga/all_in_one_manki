<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invoice PDF Parser & Editor ‚Äî Steel/Aluminum Sublines (Fixed)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Arial, sans-serif;background:#f5f7fa;padding:20px}
    .container{max-width:1800px;margin:0 auto;background:#fff;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:30px;border-radius:8px 8px 0 0}
    .header h1{margin-bottom:8px}
    .upload-section{padding:40px;text-align:center}
    .upload-box{border:3px dashed #cbd5e0;border-radius:8px;padding:40px;cursor:pointer;transition:.3s}
    .upload-box:hover{border-color:#667eea;background:#f7fafc}
    .upload-box.dragover{border-color:#667eea;background:#e6f0ff}
    #fileInput{display:none}
    .loading{padding:40px;text-align:center;display:none}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 20px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .controls{padding:20px;background:#f8f9fa;border-bottom:1px solid #dee2e6;display:none}
    .controls select{padding:10px;border:1px solid #ced4da;border-radius:4px;font-size:14px;min-width:400px;margin-right:10px}
    .controls button{padding:10px 20px;border:none;border-radius:4px;font-weight:600;cursor:pointer;margin-right:10px}
    .btn-success{background:#28a745;color:#fff}.btn-success:hover{background:#218838}
    .btn-primary{background:#007bff;color:#fff}.btn-primary:hover{background:#0056b3}
    .btn-danger{background:#dc3545;color:#fff}.btn-danger:hover{background:#c82333}
    .btn-info{background:#17a2b8;color:#fff}.btn-info:hover{background:#138496}
    .btn-warning{background:#ffc107;color:#212529}
    .stats{padding:20px;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;background:#fff3cd;display:none}
    .stat{padding:15px;background:#fff;border-radius:4px;border-left:4px solid #ffc107}
    .stat-label{font-size:11px;color:#6c757d;text-transform:uppercase;margin-bottom:5px}
    .stat-value{font-size:20px;font-weight:700}
    .stat-value.error{color:#dc3545}.stat-value.success{color:#28a745}
    .stat input{width:100%;padding:6px;border:1px solid #ced4da;border-radius:3px;font-size:16px;font-weight:bold}
    .stat.editable{border-left-color:#007bff}
    .table-container{padding:20px;display:none}
    .table-header-wrapper{background:#343a40;overflow:auto}
    .table-header-wrapper::-webkit-scrollbar{display:none}
    .table-header-wrapper{scrollbar-width:none}
    .table-header{min-width:1200px}
    .table-header table{width:100%;border-collapse:collapse}
    .table-header th{background:#343a40;color:#fff;padding:12px 8px;text-align:left;font-weight:600;font-size:13px;border:none}
    .table-body-wrapper{max-height:560px;overflow:auto}
    .table-body{min-width:1200px}
    .table-body table{width:100%;border-collapse:collapse}
    .table-body td{padding:10px 8px;border-bottom:1px solid #dee2e6;background:#fff}
    .table-body tr:hover td{background:#f8f9fa}
    .table-body td input{width:100%;padding:6px;border:1px solid #ced4da;border-radius:3px;font-size:13px}
    .table-body td input:focus{outline:none;border-color:#667eea}
    .readonly{background:#e9ecef!important}
    .actions{text-align:center}
    .actions button{padding:4px 8px;font-size:12px;margin:0 2px}
    .inline-help{font-size:12px;color:#6c757d;margin-left:8px}

    .db-section{padding:20px;background:#e7f3ff;border-bottom:1px solid #b3d9ff}
    .db-status{display:inline-block;padding:5px 10px;border-radius:4px;font-size:12px;margin-left:10px}
    .db-loaded{background:#d4edda;color:#155724}
    .db-loading{background:#fff3cd;color:#856404}
    .db-error{background:#f8d7da;color:#721c24}
    .db-info{font-size:12px;color:#004085;margin-top:5px}

    .table-header table, .table-body table{table-layout:fixed}
    .table-header th:nth-child(1), .table-body td:nth-child(1){width:44px!important}
    .table-header th:nth-child(2), .table-body td:nth-child(2){width:210px!important}
    .table-header th:nth-child(3), .table-body td:nth-child(3){width:80px!important}
    .table-header th:nth-child(4), .table-body td:nth-child(4){width:56px!important}
    .table-header th:nth-child(5), .table-body td:nth-child(5){width:120px!important}
    .table-header th:nth-child(6), .table-body td:nth-child(6){width:120px!important}
    .table-header th:nth-child(7), .table-body td:nth-child(7){width:96px!important}
    .table-header th:nth-child(8), .table-body td:nth-child(8){width:64px!important}
    .table-header th:nth-child(9), .table-body td:nth-child(9){width:140px!important}
    .table-body td{padding:6px 6px}
    .table-body td input{width:100%;}
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üìÑ Invoice PDF Parser & Editor</h1>
    <p>Steel/Aluminum sublines below each main line. Export-ready.</p>
  </div>

  <div class="db-section" id="dbSection">
    <strong>Database Status:</strong>
    <span class="db-status db-loading" id="dbStatus">Loading database from repository...</span>
    <div class="db-info" id="dbInfo">Fetching updated_manki_db.xlsx from GitHub...</div>
  </div>

  <div class="upload-section" id="uploadSection">
    <div class="upload-box" id="uploadBox">
      <h2>üì§ Upload PDF Invoice</h2>
      <p style="margin-top:10px;color:#6c757d">Click or drag & drop your PDF file here</p>
      <input type="file" id="fileInput" accept=".pdf,application/pdf" />
    </div>
  </div>

  <div class="loading" id="loading">
    <div class="spinner"></div>
    <div><strong>Processing PDF...</strong></div>
  </div>

  <div class="alert" id="alert" style="display:none"></div>

  <div class="controls" id="controls">
    <select id="invoiceSelect"><option value="">Select an invoice...</option></select>
    <button class="btn-warning" onclick="exportToDescartes()">üìã Export to Descartes Template (All Invoices)</button>
    <button class="btn-success" onclick="exportToExcel()">üì• Export All to Excel</button>
    <button class="btn-info" onclick="addBlankRowForCurrent()">‚ûï Add Blank Row</button>
    <button class="btn-primary" onclick="resetUpload()">üì§ New Upload</button>
    <span class="inline-help">Tip: Use <strong>Tab</strong>/<strong>Shift+Tab</strong> or <strong>Enter</strong> to move between fields.</span>
  </div>

  <div class="stats" id="stats">
    <div class="stat"><div class="stat-label">Invoice Number</div><div class="stat-value" id="statInvoice">-</div></div>
    <div class="stat editable"><div class="stat-label">Invoice Date (Editable)</div><input autocomplete="off" type="text" id="statDate" placeholder="MM/DD/YYYY" onchange="updateInvoiceField('invoice_date', this.value)"></div>
    <div class="stat editable"><div class="stat-label">Supplier (Editable)</div><input autocomplete="off" type="text" id="statSupplier" placeholder="Supplier name" onchange="updateInvoiceField('supplier', this.value)"></div>
    <div class="stat"><div class="stat-label">Total Line Items</div><div class="stat-value" id="statItems">0</div></div>
    <div class="stat editable"><div class="stat-label">Invoice Total (Editable)</div><input autocomplete="off" type="number" step="0.01" id="statTotal" placeholder="0.00" onchange="updateInvoiceTotal(this.value)"></div>
    <div class="stat"><div class="stat-label">Line Items Sum</div><div class="stat-value" id="statSum">$0.00</div></div>
    <div class="stat"><div class="stat-label">Difference</div><div class="stat-value" id="statDiff">$0.00</div></div>
  </div>

  <div class="table-container" id="tableContainer">
    <div class="table-header-wrapper">
      <div class="table-header">
        <table><thead><tr>
          <th style="width:48px">Pos</th>
          <th style="width:210px">Part Number</th>
          <th style="width:90px">Quantity</th>
          <th style="width:64px">Unit</th>
          <th style="width:120px">Unit Price</th>
          <th style="width:120px">Line Total</th>
          <th style="width:120px">Net Weight</th>
          <th style="width:80px">Country</th>
          <th style="width:140px">Actions</th>
        </tr></thead></table>
      </div>
    </div>
    <div class="table-body-wrapper">
      <div class="table-body">
        <table><tbody id="tableBody"></tbody></table>
      </div>
    </div>
  </div>
</div>

<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  let allData = [];
  let currentInvoice = '';
  let invoiceOrder = [];
  let uploadedPdfName = '';

  const uploadBox = document.getElementById('uploadBox');
  const fileInput = document.getElementById('fileInput');
  const headerWrap = document.querySelector('.table-header-wrapper');
  const bodyWrap = document.querySelector('.table-body-wrapper');
  if(headerWrap && bodyWrap){
    let syncing=false;
    bodyWrap.addEventListener('scroll',()=>{ if(syncing) return; syncing=true; headerWrap.scrollLeft = bodyWrap.scrollLeft; syncing=false; });
    headerWrap.addEventListener('scroll',()=>{ if(syncing) return; syncing=true; bodyWrap.scrollLeft = headerWrap.scrollLeft; syncing=false; });
  }

  uploadBox.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', e => { const f = e.target.files && e.target.files[0]; if (f) handleFile(f); });
  uploadBox.addEventListener('dragover', e => { e.preventDefault(); uploadBox.classList.add('dragover'); });
  uploadBox.addEventListener('dragleave', () => uploadBox.classList.remove('dragover'));
  uploadBox.addEventListener('drop', e => { e.preventDefault(); uploadBox.classList.remove('dragover'); const f = e.dataTransfer.files && e.dataTransfer.files[0]; if (f) handleFile(f); });

  function isPdfFile(file){ const nameOk=(file.name||'').toLowerCase().endsWith('.pdf'); const typeOk=(file.type||'').toLowerCase()==='application/pdf'; return nameOk || typeOk; }

  function showAlert(msg,type='success'){
    const el=document.getElementById('alert'); el.textContent=msg; el.style.display='block';
    el.style.background = type==='error'?'#f8d7da':'#d4edda';
    el.style.color = type==='error'?'#721c24':'#155724';
    el.style.border = type==='error'?'1px solid #f5c6cb':'1px solid #c3e6cb';
    setTimeout(()=>{ el.style.display='none'; }, 4000);
  }

  async function handleFile(file){
    if(!isPdfFile(file)){ showAlert('Please upload a PDF file','error'); return; }
    uploadedPdfName = (file.name||'').replace(/\.pdf$/i,'');

    document.getElementById('uploadSection').style.display='none';
    document.getElementById('loading').style.display='block';

    try{
      const arrayBuffer = await file.arrayBuffer();
      const uint8 = new Uint8Array(arrayBuffer);
      const pdf = await pdfjsLib.getDocument({data:uint8}).promise;

      let fullText='';
      for(let i=1;i<=pdf.numPages;i++){
        try{
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent({includeMarkedContent:true});
          const items = (textContent && Array.isArray(textContent.items))? textContent.items:[];
          const pageText = items.map(it=> (it && typeof it.str==='string') ? it.str : '').join(' ');
          fullText += (pageText||'') + '\n';
        }catch(perPageErr){ console.warn('Failed to read page',i,perPageErr); }
      }

      if(!fullText.trim()){
        showAlert('‚ö†Ô∏è The PDF had no extractable text (it may be scanned). Try an OCR‚Äôd copy.','error');
        document.getElementById('uploadSection').style.display='block';
        return;
      }

      parseInvoices(fullText);

      if(allData.length>0){
        const invoiceCount = new Set(allData.map(d=>d.invoice_number)).size;
        showAlert(`‚úÖ Found ${invoiceCount} invoice(s) with ${allData.length} line items`,'success');
        setupInterface();
      }else{
        showAlert('‚ö†Ô∏è No invoice data found in PDF.','error');
        document.getElementById('uploadSection').style.display='block';
      }
    }catch(err){
      console.error('PDF processing error:',err); showAlert('Error: '+(err.message||String(err)),'error');
      document.getElementById('uploadSection').style.display='block';
    }finally{
      document.getElementById('loading').style.display='none';
    }
  }

  function parseFloatSafe(s){ if(s==null) return NaN; const t=String(s).replace(/[\,\s]/g,''); const v=parseFloat(t); return isNaN(v)?NaN:v; }
  function fmt2(n){ const v=parseFloatSafe(n); return isNaN(v)?'':v.toFixed(2); }
  function isNum(v){ return Number.isFinite(parseFloatSafe(v)); }

  function parseInvoices(text){
    allData=[]; invoiceOrder=[]; text = String(text||'');

    // Split invoices
    const splits = text.split(/Customs\s+Invoice\s+(\d+)\s+from/gi);
    const invoiceGroups = {};
    for(let i=1;i<splits.length;i+=2){
      const invoiceNum = splits[i]; const sectionText = splits[i+1];
      if(!invoiceNum || !sectionText) continue;
      if(!invoiceGroups[invoiceNum]){ invoiceOrder.push(invoiceNum); invoiceGroups[invoiceNum]=''; }
      invoiceGroups[invoiceNum] += sectionText + '\n';
    }

    Object.keys(invoiceGroups).forEach(invoiceNum => {
      const sectionText = invoiceGroups[invoiceNum] || '';

      const dateMatch = sectionText.match(/^\s*(\d{2}\/\d{2}\/\d{4})/);
      const invoiceDate = dateMatch ? dateMatch[1] : '';

      const headerSlice = sectionText.substring(0,1400);
      let supplier='';
      const supplierPattern=/(R√ºdt Industrielacke GmbH & Co\. KG|Norix Lackfabrik GmbH & Co\. KG|Finalin GmbH & Co\. KG|Mankiewicz Coatings, LLC)/i;
      const supplierMatch = headerSlice.match(supplierPattern);
      if(supplierMatch){ supplier = supplierMatch[1].trim(); }

      let invoiceTotal='';
      const overallPattern=/Overall\s+amount\s+in\s+USD\s+([\d,]+\.?\d*)/gi;
      const overallMatches=[...sectionText.matchAll(overallPattern)];
      if(overallMatches.length) invoiceTotal = overallMatches.at(-1)[1].replace(/,/g,'');

      // === LINE PARSING ===
      const UNIT_WORD = '(?:carton|bucket(?:s|\\(s\\))?|pail|tin|can|barrel|canister|cartridge|bottle(?:s|\\(s\\))?|piece(?:\\(s\\))?|can(?:\\(s\\))?|pail(?:\\(s\\))?|tin(?:\\(s\\))?|Kilogramme)';
      const linePatternA = new RegExp(
        String.raw`(\d+)\s+([A-Z0-9.\-]+)\s+([\d,]+\.?\d*)\s+${UNIT_WORD}\s*(?:\([^)]*\)\s*)?` +
        String.raw`x\s*([\d,]+\.?\d+)\s+([A-Z]+)\s+` +
        String.raw`([\d,]+\.?\d+)\s+([A-Z]+)\s+` +
        String.raw`([\d.,]+)\s+USD\/(FOZ|KG|GAL|QT|PT|CN|PC|L|CAT|TIN|BTL|BUC)\s+` +
        String.raw`([\d,]+\.?\d+)`,
        'gi'
      );
      const linePatternB = new RegExp(
        String.raw`(\d+)\s+([A-Z0-9.\-]+)\s+([\d,]+\.?\d*)\s+${UNIT_WORD}\s*` +
        String.raw`([\d,]+\.?\d+)\s+([A-Z]+)\s+` +
        String.raw`([\d.,]+)\s+USD\/(FOZ|KG|GAL|QT|PT|CN|PC|L|CAT|TIN|BTL|BUC)\s+` +
        String.raw`([\d,]+\.?\d+)`,
        'gi'
      );

      const positionsFound = new Set();
      const lineItems = [];

      function pushItem(c){
        const {position,partNumber,containerQty,perUnitQty,perUnitType,totalQty,totalUnit,unitPrice,priceUnit,lineTotal,matchIndex}=c;
        let quantity, unit;
        if(['CN','PC','CAT','TIN','BTL','BUC'].includes(priceUnit)){
          quantity = containerQty || totalQty; unit = priceUnit;
        }else if(['KG','GAL','PT','QT','FOZ','L'].includes(priceUnit)){
          quantity = totalQty; unit = priceUnit;
        }else if(priceUnit === totalUnit){
          quantity = totalQty; unit = priceUnit;
        }else{ quantity = totalQty; unit = priceUnit; }

        lineItems.push({
          invoice_number:invoiceNum,
          invoice_date:invoiceDate,
          invoice_total:invoiceTotal,
          supplier:supplier,
          position,
          part_number:partNumber,
          quantity, unit,
          unit_price:unitPrice,
          line_total:lineTotal,
          net_weight:'', country_of_origin:'',
          _matchIndex:matchIndex
        });
      }

      let mA; while((mA=linePatternA.exec(sectionText))!==null){
        const position=mA[1]; if(positionsFound.has(position)) continue; positionsFound.add(position);
        pushItem({
          position,
          partNumber:(mA[2]||'').slice(0,64),
          containerQty:(mA[3]||'').replace(/,/g,''),
          perUnitQty:(mA[4]||'').replace(/,/g,''),
          perUnitType:mA[5]||'',
          totalQty:(mA[6]||'').replace(/,/g,''),
          totalUnit:mA[7]||'',
          unitPrice:mA[8]||'',
          priceUnit:mA[9]||'',
          lineTotal:(mA[10]||'').replace(/,/g,''),
          matchIndex:mA.index ?? 0
        });
      }

      let mB; while((mB=linePatternB.exec(sectionText))!==null){
        const position=mB[1]; if(positionsFound.has(position)) continue; positionsFound.add(position);
        pushItem({
          position,
          partNumber:(mB[2]||'').slice(0,64),
          containerQty:(mB[3]||'').replace(/,/g,''),
          perUnitQty:'', perUnitType:'',
          totalQty:(mB[4]||'').replace(/,/g,''),
          totalUnit:mB[5]||'',
          unitPrice:(mB[6]||''),
          priceUnit:mB[7]||'',
          lineTotal:(mB[8]||'').replace(/,/g,''),
          matchIndex:mB.index ?? 0
        });
      }

      // === ENRICH & ADD SUBLINES (robust to broken spacing like "St eel") ===
      const enriched=[];
      for(let idx=0; idx<lineItems.length; idx++){
        const item=lineItems[idx];
        const startPos=item._matchIndex ?? 0;
        const endPos = idx < lineItems.length-1 ? (lineItems[idx+1]._matchIndex ?? (startPos+4000)) : (startPos+8000);
        let itemSection = sectionText.substring(startPos, Math.min(endPos, sectionText.length));

        // --- Normalize broken words & whitespace seen in Manki-test ---
        let norm = itemSection;
        norm = norm.replace(/\s+/g,' ');                       // collapse spaces
        norm = norm.replace(/st\s*eel/ig,'steel');             // "st eel" -> steel
        norm = norm.replace(/w\s*eight/ig,'weight');           // "w eight" -> weight
        norm = norm.replace(/alumin(?:iu)?\s*m/ig,'aluminum'); // "alumini um" -> aluminum
        norm = norm.replace(/countr\w*\s+of\s+melt\s+and\s+pour/ig,'country of melt and pour');
        norm = norm.replace(/countr\w*\s+of\s+smelt\s+and\s+cast/ig,'country of smelt and cast');
        norm = norm.replace(/Total\s+invoice\s+value/ig,'Total invoice value'); // ensure anchor
        norm = norm.replace(/Less\s+steel\s+packaging/ig,'Less steel packaging');
        norm = norm.replace(/Net\s+product\s+value/ig,'Net product value');

        // COO
        const cooMatch=norm.match(/Country\s+of\s+origin:\s*([A-Za-z ]+)/i);
        if(cooMatch){
          let country=(cooMatch[1]||'').trim();
          const lc=country.toLowerCase();
          if(lc.includes('germany')) country='DE';
          else if(lc.includes('netherlands')) country='NL';
          else if(lc.includes('united kingdom')) country='GB';
          else if(lc.includes('mozambique')) country='MZ';
          item.country_of_origin = country;
        }

        // Heuristic net weight (liquid L pair)
        const weightMatch=norm.match(/(\d[\d,.]*)\s+L\s+(\d[\d,.]*)\s+L/);
        if(weightMatch){ item.net_weight=(weightMatch[2]||'').replace(/,/g,''); }

        // --- Steel block ---
        const steelBlock = (() => {
          const m = norm.match(/9903\.81\.91\s*-\s*Steel\s*Packaging([\s\S]*?)(?:9903\.85\.08|Total invoice value|Less steel packaging|Net product value|Country of origin|$)/i);
          return m ? m[1] : '';
        })();

        let steelWeightKG = NaN, steelCustomsUSD = NaN, steelCountry='';
        if(steelBlock){
          const w = steelBlock.match(/Total\s+net\s+steel\s+weight\s+per\s+KG:?\s*([0-9,.\-NA\/ ]+)/i);
          if(w){ const v = w[1].replace(/[^\d.,-]/g,''); steelWeightKG = parseFloatSafe(v); }
          const c = steelBlock.match(/Total\s+customs\s+value:?\s*([0-9,.\-NA\/ ]+)\s*USD/i);
          if(c){ const vv = c[1].replace(/[^\d.,-]/g,''); steelCustomsUSD = parseFloatSafe(vv); }
          const cm = steelBlock.match(/country of melt and pour\s*:\s*([A-Za-z ]+)/i);
          if(cm){ steelCountry = cm[1].trim(); }
        }

        // --- Aluminum block ---
        const alumBlock = (() => {
          const m = norm.match(/9903\.85\.08\s*-\s*Aluminum\s*Content[\s\S]*?(?=Total invoice value|Less steel packaging|Net product value|Country of origin|$)/i);
          return m ? m[0] : '';
        })();

        let alumContentKG = NaN, alumCustomsUSD = NaN, alumCountry='';
        if(alumBlock){
          const a = alumBlock.match(/Total\s+aluminum\s+content\s*:\s*([0-9,.\-NA\/ ]+)\s*KG/i);
          if(a){ const v = a[1].replace(/[^\d.,-]/g,''); alumContentKG = parseFloatSafe(v); }
          const ac = alumBlock.match(/Total\s+customs\s+value\s*:\s*([0-9,.\-NA\/ ]+)\s*USD/i);
          if(ac){ const vv = ac[1].replace(/[^\d.,-]/g,''); alumCustomsUSD = parseFloatSafe(vv); }
          const am = alumBlock.match(/country of smelt and cast\s*:\s*([A-Za-z ]+)/i);
          if(am){ alumCountry = am[1].trim(); }
        }

        // Build enriched list: base item, then S/A sublines if numeric customs
        const baseClone = {...item};
        let minusFromBase = 0;

        enriched.push(baseClone);

        if(isNum(steelCustomsUSD)){
          enriched.push({
            ...item,
            position: String(item.position)+'S',
            part_number: 'STEEL PACKAGING',
            quantity: isNum(steelWeightKG)? fmt2(steelWeightKG):'',
            unit: 'KG',
            unit_price: '',
            line_total: fmt2(steelCustomsUSD),
            net_weight: isNum(steelWeightKG)? fmt2(steelWeightKG):'',
            country_of_origin: steelCountry || item.country_of_origin
          });
          minusFromBase += steelCustomsUSD || 0;
        }

        if(isNum(alumCustomsUSD)){
          enriched.push({
            ...item,
            position: String(item.position)+'A',
            part_number: 'ALUMINUM CONTENT',
            quantity: isNum(alumContentKG)? fmt2(alumContentKG):'',
            unit: 'KG',
            unit_price: '',
            line_total: fmt2(alumCustomsUSD),
            net_weight: isNum(alumContentKG)? fmt2(alumContentKG):'',
            country_of_origin: alumCountry || item.country_of_origin
          });
          minusFromBase += alumCustomsUSD || 0;
        }

        // Subtract numeric customs from base line total (if any)
        if(isNum(baseClone.line_total) && minusFromBase>0){
          baseClone.line_total = fmt2(parseFloatSafe(baseClone.line_total) - minusFromBase);
          enriched[enriched.length-1-(isNum(alumCustomsUSD)?1:0)-(isNum(steelCustomsUSD)?1:0)] = baseClone;
        }
      }

      // Append to global
      allData.push(...enriched);
    });
  }

  // ==== UI Helpers (unchanged from your version) ====

  function setupInterface(){
    const controls=document.getElementById('controls');
    const stats=document.getElementById('stats');
    const tableContainer=document.getElementById('tableContainer');
    controls.style.display='block'; stats.style.display='grid'; tableContainer.style.display='block';

    const invoices=[...new Set(allData.map(d=>d.invoice_number))];
    const sel=document.getElementById('invoiceSelect');
    sel.innerHTML='<option value="">Select an invoice...</option>'+invoices.map(i=>`<option value="${i}">${i}</option>`).join('');
    if(invoices.length){ sel.value=invoices[0]; currentInvoice=invoices[0]; refreshTable(); refreshStats(); }
    sel.onchange=()=>{ currentInvoice=sel.value; refreshTable(); refreshStats(); };
  }

  function updateInvoiceField(field,val){
    allData.forEach(r=>{ if(r.invoice_number===currentInvoice){ r[field]=val; }});
    refreshStats();
  }
  function updateInvoiceTotal(val){
    allData.forEach(r=>{ if(r.invoice_number===currentInvoice){ r.invoice_total=val; }});
    refreshStats();
  }

  function refreshStats(){
    const items=allData.filter(d=>d.invoice_number===currentInvoice);
    const totalLines=items.length;
    const inv=items[0]||{};
    const sum = items.reduce((a,b)=> a + (parseFloatSafe(b.line_total)||0), 0);
    const diff = (parseFloatSafe(inv.invoice_total)||0) - sum;

    document.getElementById('statInvoice').textContent=currentInvoice||'-';
    document.getElementById('statDate').value=inv.invoice_date||'';
    document.getElementById('statSupplier').value=inv.supplier||'';
    document.getElementById('statItems').textContent=String(totalLines);
    document.getElementById('statTotal').value=inv.invoice_total||'';
    document.getElementById('statSum').textContent='$'+fmt2(sum);
    document.getElementById('statDiff').textContent='$'+fmt2(diff);
  }

  function refreshTable(){
    const tb=document.getElementById('tableBody');
    const rows=allData.filter(d=>d.invoice_number===currentInvoice);
    rows.sort((a,b)=>{
      const pa=String(a.position), pb=String(b.position);
      const na=parseInt(pa,10), nb=parseInt(pb,10);
      if(!isNaN(na) && !isNaN(nb) && na!==nb) return na-nb;
      if(!isNaN(na) && isNaN(nb)) return -1;
      if(isNaN(na) && !isNaN(nb)) return 1;
      return pa.localeCompare(pb);
    });

    tb.innerHTML = rows.map((r,idx)=>`
      <tr>
        <td><input value="${r.position||''}" onchange="editCell(${idx},'position',this.value)"></td>
        <td><input value="${r.part_number||''}" onchange="editCell(${idx},'part_number',this.value)"></td>
        <td><input value="${r.quantity||''}" onchange="editCell(${idx},'quantity',this.value)"></td>
        <td><input value="${r.unit||''}" onchange="editCell(${idx},'unit',this.value)"></td>
        <td><input value="${r.unit_price||''}" onchange="editCell(${idx},'unit_price',this.value)"></td>
        <td><input value="${r.line_total||''}" onchange="editCell(${idx},'line_total',this.value)"></td>
        <td><input value="${r.net_weight||''}" onchange="editCell(${idx},'net_weight',this.value)"></td>
        <td><input value="${r.country_of_origin||''}" onchange="editCell(${idx},'country_of_origin',this.value)"></td>
        <td class="actions">
          <button class="btn-danger" onclick="deleteRow(${idx})">Delete</button>
          <button class="btn-info" onclick="addRowBelow(${idx})">Add Below</button>
        </td>
      </tr>
    `).join('');
  }

  function rowsForCurrent(){ return allData.filter(d=>d.invoice_number===currentInvoice); }
  function editCell(viewIdx,key,val){
    const rows = rowsForCurrent();
    const row = rows[viewIdx];
    if(!row) return;
    // find the actual object reference in allData
    const idx = allData.indexOf(allData.filter(d=>d.invoice_number===currentInvoice)[viewIdx]);
    if(idx>=0){ allData[idx][key]=val; refreshStats(); }
  }
  function deleteRow(viewIdx){
    const list = allData.filter(d=>d.invoice_number===currentInvoice);
    const target = list[viewIdx];
    if(!target) return;
    const abs = allData.indexOf(target);
    if(abs>=0){ allData.splice(abs,1); refreshTable(); refreshStats(); }
  }
  function addRowBelow(viewIdx){
    const list = allData.filter(d=>d.invoice_number===currentInvoice);
    const base = list[viewIdx]; if(!base) return;
    const abs = allData.indexOf(base);
    const blank = {...base, position:'', part_number:'', quantity:'', unit:'', unit_price:'', line_total:'', net_weight:''};
    allData.splice(abs+1,0,blank); refreshTable(); refreshStats();
  }
  function addBlankRowForCurrent(){
    const any = allData.find(d=>d.invoice_number===currentInvoice); if(!any) return;
    const blank = {...any, position:'', part_number:'', quantity:'', unit:'', unit_price:'', line_total:'', net_weight:''};
    allData.push(blank); refreshTable(); refreshStats();
  }

  // === Minimal stubs for exports (same as your file) ===
  function exportToExcel(){ showAlert('Export to Excel not changed in this fix.'); }
  function exportToDescartes(){ showAlert('Descartes export (all invoices) not changed in this fix.'); }

  function resetUpload(){
    allData=[]; currentInvoice=''; invoiceOrder=[];
    document.getElementById('controls').style.display='none';
    document.getElementById('stats').style.display='none';
    document.getElementById('tableContainer').style.display='none';
    document.getElementById('uploadSection').style.display='block';
    document.getElementById('invoiceSelect').innerHTML='<option value="">Select an invoice...</option>';
  }
</script>
</body>
</html>
