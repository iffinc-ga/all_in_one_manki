<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Unified Invoice Parser + Steel/Aluminum Capture</title>
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root { --bg:#f6f8fb; --card:#fff; --text:#1f2937; --muted:#6b7280; --primary:#4f46e5; --success:#16a34a; --danger:#dc2626; --amber:#f59e0b; --border:#e5e7eb; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Noto Color Emoji"; color: var(--text); background: var(--bg); }
    .wrap { max-width: 1400px; margin: 24px auto; padding: 0 16px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,.03); overflow: hidden; }
    .header { padding: 20px 24px; background: linear-gradient(135deg, #4f46e5, #7c3aed); color: #fff; }
    .header h1 { margin: 0 0 4px; font-size: 22px; }
    .sub { opacity: .9; font-size: 14px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .section { padding: 18px 20px; border-top: 1px solid var(--border); }
    .upload { border: 2px dashed var(--border); border-radius: 10px; padding: 28px; text-align: center; cursor: pointer; transition: .2s; }
    .upload:hover { border-color: var(--primary); background: #f8fafc; }
    .hidden { display: none !important; }
    .btn { appearance: none; border: 1px solid var(--border); background: #fff; color: var(--text); padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 600; }
    .btn.primary { background: var(--primary); color: #fff; border-color: transparent; }
    .btn.success { background: var(--success); color: #fff; border-color: transparent; }
    .btn.danger { background: var(--danger); color: #fff; border-color: transparent; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    select, input[type="text"], input[type="number"] { border: 1px solid var(--border); border-radius: 8px; padding: 8px 10px; font-size: 14px; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
    .stat { background:#fafafa; border:1px solid var(--border); border-radius:10px; padding:12px; }
    .stat .label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: .04em; }
    .stat .value { font-size: 16px; font-weight: 700; margin-top: 6px; }
    .alert { padding: 12px 14px; border-left: 4px solid var(--amber); background: #fff7ed; border:1px solid #fed7aa; border-radius: 8px; color:#7c2d12; }

    table { width: 100%; border-collapse: collapse; }
    thead th { position: sticky; top: 0; background: #111827; color: #fff; text-align: left; font-size: 12px; padding: 10px 8px; }
    tbody td { background: #fff; font-size: 13px; border-bottom: 1px solid var(--border); padding: 8px; vertical-align: top; }
    tbody tr:hover td { background: #fafafa; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .right { text-align: right; }
    .nowrap { white-space: nowrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <h1>Unified Invoice Parser + Steel/Aluminum Capture</h1>
        <div class="sub">Upload a Mankiewicz (or similar) PDF ‚Üí select invoice ‚Üí auto-capture line items + 9903 steel/aluminum metrics ‚Üí export to Excel.</div>
      </div>

      <div class="section">
        <div id="uploadBox" class="upload">
          <input id="fileInput" type="file" accept="application/pdf,.pdf" class="hidden" />
          <div><strong>üì§ Click to upload</strong> or drag & drop a PDF here</div>
          <div class="sub" style="margin-top:6px">Supports units like L, GAL, QT, BTL, CN, TIN, BUC, etc., and USD/BTL & USD/BUC pricing.</div>
        </div>
        <div id="loading" class="alert hidden">Processing PDF‚Ä¶</div>
      </div>

      <div class="section row hidden" id="controls">
        <select id="invoiceSelect"></select>
        <button class="btn primary" id="btnExport">Export current invoice to Excel</button>
        <button class="btn" id="btnExportAll">Export all invoices to Excel</button>
        <span class="sub">Tip: You can edit any cell in the table before exporting.</span>
      </div>

      <div class="section hidden" id="topStats">
        <div class="stats">
          <div class="stat"><div class="label">Invoice</div><div class="value" id="statInv">‚Äì</div></div>
          <div class="stat"><div class="label">Date</div><div class="value" id="statDate">‚Äì</div></div>
          <div class="stat"><div class="label">Supplier</div><div class="value" id="statSupplier">‚Äì</div></div>
          <div class="stat"><div class="label">Lines</div><div class="value" id="statLines">0</div></div>
        </div>
      </div>

      <div class="section hidden" id="tableWrap" style="max-height: 520px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th class="nowrap">Pos</th>
              <th>Product No.</th>
              <th>Description</th>
              <th class="nowrap">Qty</th>
              <th class="nowrap">Unit</th>
              <th class="nowrap right">Unit Price</th>
              <th class="nowrap right">Line Total</th>
              <th class="nowrap right">Steel Net (KG)</th>
              <th class="nowrap right">Steel Customs (USD)</th>
              <th class="nowrap right">Alum Customs (USD)</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

    </div>
  </div>

  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    const el = id => document.getElementById(id);
    const uploadBox = el('uploadBox');
    const fileInput = el('fileInput');
    const loading = el('loading');
    const controls = el('controls');
    const invoiceSelect = el('invoiceSelect');
    const topStats = el('topStats');
    const statInv = el('statInv');
    const statDate = el('statDate');
    const statSupplier = el('statSupplier');
    const statLines = el('statLines');
    const tableWrap = el('tableWrap');
    const tbody = el('tbody');
    const btnExport = el('btnExport');
    const btnExportAll = el('btnExportAll');

    uploadBox.addEventListener('click', () => fileInput.click());
    uploadBox.addEventListener('dragover', e => { e.preventDefault(); uploadBox.style.borderColor = '#4f46e5'; });
    uploadBox.addEventListener('dragleave', () => uploadBox.style.borderColor = 'var(--border)');
    uploadBox.addEventListener('drop', e => { e.preventDefault(); const f = e.dataTransfer.files[0]; if (f) handlePdf(f); });
    fileInput.addEventListener('change', e => { const f = e.target.files[0]; if (f) handlePdf(f); });

    let invoices = {};
    let invoiceOrder = [];

    async function handlePdf(file){
      if(!/\.pdf$/i.test(file.name)) return alert('Please upload a PDF file.');
      uploadBox.classList.add('hidden');
      loading.classList.remove('hidden');

      try {
        const uint8 = new Uint8Array(await file.arrayBuffer());
        const pdf = await pdfjsLib.getDocument({ data: uint8 }).promise;
        let fullText = '';
        for (let i=1;i<=pdf.numPages;i++){
          try{
            const page = await pdf.getPage(i);
            const txt = await page.getTextContent({ includeMarkedContent:true });
            const items = Array.isArray(txt.items) ? txt.items : [];
            fullText += items.map(t=> (t && t.str) ? t.str : '').join(' ') + '\n';
          }catch(err){ console.warn('Read page failed', i, err); }
        }
        if(!fullText.trim()) throw new Error('No extractable text (consider OCR).');
        parseAll(fullText);
        populateInvoiceSelect();
      } catch (err){
        console.error(err);
        alert('PDF error: ' + (err.message||String(err)));
        uploadBox.classList.remove('hidden');
      } finally {
        loading.classList.add('hidden');
      }
    }

    const money = s => s==null||s===''? '' : Number(s).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
    const num = s => s==null||s===''? '' : Number(s).toLocaleString(undefined, {maximumFractionDigits:3});

    function parseAll(text){
      invoices = {}; invoiceOrder = [];

      const parts = text.split(/Customs\s+Invoice\s+(\d+)\s+from/gi);
      for (let i=1;i<parts.length;i+=2){
        const inv = parts[i];
        const section = parts[i+1] || '';
        if (!inv) continue;
        if (!invoices[inv]) { invoices[inv] = { meta:{}, lines:[] }; invoiceOrder.push(inv); }

        const dateMatch = section.match(/\b(\d{2}\/\d{2}\/\d{4})\b/);
        invoices[inv].meta.date = dateMatch ? dateMatch[1] : '';

        const head = section.slice(0, 500);
        const supplierMatch = head.match(/(Mankiewicz|Finalin|R√ºdt|Norix)[^\n]*?/i);
        invoices[inv].meta.supplier = supplierMatch ? supplierMatch[0] : '';

        const blocks = section.split(/\s(?=\d{1,4}\s+[A-Z0-9][A-Z0-9.\-]*\s)/g);
        blocks.forEach(b => {
          const posMatch = b.match(/\b(\d{1,4})\s+([A-Z0-9][A-Z0-9.\-]+)/);
          if(!posMatch) return;
          const pos = posMatch[1];
          const productNo = posMatch[2];

          let qty = '', unit = '', unitPrice = '', lineTotal = '';
          const qtyLine = b.match(/\b(\d{1,6}(?:\.\d+)?)\s*(bottle\(s\)|bottle|bottles|can\(s\)|can|cans|canister\(s\)?|canister|canisters|tin\(s\)|tin|tins|bucket\(s\)|bucket|buckets|pail\(s\)?|pail|piece\(s\)?|pieces|canister|canisters|can|GAL|QT|L|CN|BTL|BUC)\b[^\n]*?\s(\d{1,6}(?:\.\d+)?)\s*USD\/(?:L|GAL|QT|BTL|CN|TIN|BUC|CAN)\s+(\d{1,3}(?:[\d,.]*\d)?)\b/iu);
          if(qtyLine){
            qty = qtyLine[1];
            unit = qtyLine[2].replace(/\(s\)/i,'').toUpperCase();
            unitPrice = qtyLine[3];
            lineTotal = (qtyLine[4]||'').replace(/,/g,'');
          } else {
            const priceOnly = b.match(/\b(\d{1,6}(?:\.\d+)?)\s*USD\/(?:L|GAL|QT|BTL|CN|TIN|BUC|CAN)\b/);
            if(priceOnly) unitPrice = priceOnly[1];
            const totalOnly = b.match(/\bTotal\s+invoice\s+value:\s*([\d,.]+)\s*USD/i);
            if(totalOnly) lineTotal = totalOnly[1].replace(/,/g,'');
            const qtyOnly = b.match(/\b(\d{1,6}(?:\.\d+)?)\s*(bottle\(s\)|bottle|bottles|can\(s\)|can|cans|canister\(s\)?|canister|canisters|tin\(s\)|tin|tins|bucket\(s\)|bucket|buckets|pail\(s\)?|pail|piece\(s\)?|pieces|GAL|QT|L|CN|BTL|BUC)\b/i);
            if(qtyOnly){ qty = qtyOnly[1]; unit = qtyOnly[2].replace(/\(s\)/i,'').toUpperCase(); }
          }

          // --- 9903.81.91 Steel (tolerant) ---
          let steelNetKg = '', steelCustomsUsd = '';
          const steelBlock = extractAround(b, /9903[\s.\-]*81[\s.\-]*91[\s\-]*-?\s*Steel/i);
          if (steelBlock){
            const netMatch = steelBlock.match(/Total\s+net\s+steel\s+weight(?:\s+per\s+KG)?\s*:?\s*([\d,.]+)\s*(?:KG|KGS)?/i);
            if (netMatch) steelNetKg = netMatch[1].replace(/,/g,'');
            const cvMatch = steelBlock.match(/Total\s+customs\s+value\s*:? \s*([\d,.]+)(?:\s*USD)?/i);
            if (cvMatch) steelCustomsUsd = cvMatch[1].replace(/,/g,'');
          }

          // --- 9903.85.08 Aluminum (tolerant) ---
          let alumCustomsUsd = '';
          const alumBlock = extractAround(b, /9903[\s.\-]*85[\s.\-]*08[\s\-]*-?\s*Aluminum/i);
          if (alumBlock){
            const acv = alumBlock.match(/Total\s+customs\s+value\s*:? \s*(N\/A|[\d,.]+)(?:\s*USD)?/i);
            if (acv) {
              const val = acv[1].toUpperCase() === 'N/A' ? '' : acv[1];
              alumCustomsUsd = (val||'').replace(/,/g,'');
            }
          }

          const desc = extractDescription(b, productNo);

          invoices[inv].lines.push({
            pos, productNo, description: desc,
            qty, unit, unitPrice, lineTotal,
            steelNetKg, steelCustomsUsd, alumCustomsUsd
          });
        });
      }
    }

    function extractAround(text, anchorRegex){
      const m = text.match(anchorRegex);
      if(!m) return '';
      const idx = m.index || 0;
      // expanded window so ‚ÄúTotal ‚Ä¶‚Äù lines aren‚Äôt cut off
      return text.slice(idx, idx + 1200);
    }

    function extractDescription(block, productNo){
      const start = block.indexOf(productNo);
      if (start < 0) return '';
      const slice = block.slice(start + productNo.length, start + productNo.length + 160);
      return slice.replace(/\s+/g,' ').trim();
    }

    function populateInvoiceSelect(){
      if (invoiceOrder.length === 0){
        alert('No invoices detected.');
        uploadBox.classList.remove('hidden');
        return;
      }
      invoiceSelect.innerHTML = invoiceOrder.map(n => `<option value="${n}">Invoice ${n}</option>`).join('');
      controls.classList.remove('hidden');
      topStats.classList.remove('hidden');
      tableWrap.classList.remove('hidden');
      invoiceSelect.addEventListener('change', renderCurrent);
      btnExport.addEventListener('click', () => exportExcel(invoiceSelect.value));
      btnExportAll.addEventListener('click', exportAllExcel);
      renderInvoice(invoiceOrder[0]);
      invoiceSelect.value = invoiceOrder[0];
    }

    function renderCurrent(){ renderInvoice(invoiceSelect.value); }

    function renderInvoice(num){
      const inv = invoices[num];
      if(!inv) return;
      statInv.textContent = num || '‚Äì';
      statDate.textContent = inv.meta.date || '‚Äì';
      statSupplier.textContent = inv.meta.supplier || '‚Äì';
      statLines.textContent = inv.lines.length;

      tbody.innerHTML = '';
      inv.lines.forEach((ln, idx) => tbody.appendChild(makeRow(num, idx, ln)));
    }

    function makeRow(invNum, idx, ln){
      const tr = document.createElement('tr');
      const cols = [
        cellTxt(ln.pos, 'center'),
        cellTxt(ln.productNo, 'mono'),
        cellInput(invNum, idx, 'description', ln.description),
        cellInput(invNum, idx, 'qty', ln.qty, 'right', 'number', '0.001'),
        cellInput(invNum, idx, 'unit', ln.unit),
        cellInput(invNum, idx, 'unitPrice', ln.unitPrice, 'right', 'number', '0.00001'),
        cellInput(invNum, idx, 'lineTotal', ln.lineTotal, 'right', 'number', '0.01'),
        cellInput(invNum, idx, 'steelNetKg', ln.steelNetKg, 'right', 'number', '0.001'),
        cellInput(invNum, idx, 'steelCustomsUsd', ln.steelCustomsUsd, 'right', 'number', '0.01'),
        cellInput(invNum, idx, 'alumCustomsUsd', ln.alumCustomsUsd, 'right', 'number', '0.01'),
      ];
      cols.forEach(td => tr.appendChild(td));
      return tr;
    }

    function cellTxt(text, extra){
      const td = document.createElement('td');
      td.textContent = text == null ? '' : text;
      if (extra === 'mono') td.classList.add('mono');
      if (extra === 'right') td.classList.add('right');
      if (extra === 'center') td.style.textAlign = 'center';
      return td;
    }

    function cellInput(invNum, idx, key, value, extra, type='text', step='any'){
      const td = document.createElement('td');
      if (extra === 'right') td.classList.add('right');
      const input = document.createElement('input');
      input.type = type; input.step = step; input.value = value ?? '';
      input.addEventListener('change', e => { invoices[invNum].lines[idx][key] = e.target.value; });
      td.appendChild(input);
      return td;
    }

    function exportExcel(invNum){
      const inv = invoices[invNum];
      if(!inv) return alert('No invoice selected');
      const rows = inv.lines.map(l => ({
        Invoice: invNum,
        Date: inv.meta.date || '',
        Supplier: inv.meta.supplier || '',
        Pos: l.pos,
        Product_No: l.productNo,
        Description: l.description,
        Qty: toNumber(l.qty),
        Unit: l.unit,
        Unit_Price_USD: toNumber(l.unitPrice),
        Line_Total_USD: toNumber(l.lineTotal),
        Steel_Net_KG: toNumber(l.steelNetKg),
        Steel_Customs_USD: toNumber(l.steelCustomsUsd),
        Aluminum_Customs_USD: toNumber(l.alumCustomsUsd)
      }));
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, `INV_${invNum}`);
      XLSX.writeFile(wb, `invoice_${invNum}_steel_alum.xlsx`);
    }

    function exportAllExcel(){
      const wb = XLSX.utils.book_new();
      invoiceOrder.forEach(invNum => {
        const inv = invoices[invNum]; if(!inv) return;
        const rows = inv.lines.map(l => ({
          Invoice: invNum,
          Date: inv.meta.date || '',
          Supplier: inv.meta.supplier || '',
          Pos: l.pos,
          Product_No: l.productNo,
          Description: l.description,
          Qty: toNumber(l.qty),
          Unit: l.unit,
          Unit_Price_USD: toNumber(l.unitPrice),
          Line_Total_USD: toNumber(l.lineTotal),
          Steel_Net_KG: toNumber(l.steelNetKg),
          Steel_Customs_USD: toNumber(l.steelCustomsUsd),
          Aluminum_Customs_USD: toNumber(l.alumCustomsUsd)
        }));
        const ws = XLSX.utils.json_to_sheet(rows);
        XLSX.utils.book_append_sheet(wb, ws, `INV_${invNum}`);
      });
      XLSX.writeFile(wb, 'invoices_steel_alum_all.xlsx');
    }

    function toNumber(v){ if(v==null||v==='') return ''; const n = Number(String(v).replace(/,/g,'')); return isFinite(n) ? n : ''; }
  </script>
</body>
</html>
