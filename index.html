<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invoice PDF Parser & Editor ‚Äî Steel/Aluminum Sublines</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Arial, sans-serif;background:#f5f7fa;padding:20px}
    .container{max-width:1800px;margin:0 auto;background:#fff;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:30px;border-radius:8px 8px 0 0}
    .header h1{margin-bottom:8px}
    .upload-section{padding:40px;text-align:center}
    .upload-box{border:3px dashed #cbd5e0;border-radius:8px;padding:40px;cursor:pointer;transition:.3s}
    .upload-box:hover{border-color:#667eea;background:#f7fafc}
    .upload-box.dragover{border-color:#667eea;background:#e6f0ff}
    #fileInput{display:none}
    .loading{padding:40px;text-align:center;display:none}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 20px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .controls{padding:20px;background:#f8f9fa;border-bottom:1px solid #dee2e6;display:none}
    .controls select{padding:10px;border:1px solid #ced4da;border-radius:4px;font-size:14px;min-width:400px;margin-right:10px}
    .controls button{padding:10px 20px;border:none;border-radius:4px;font-weight:600;cursor:pointer;margin-right:10px}
    .btn-success{background:#28a745;color:#fff}.btn-success:hover{background:#218838}
    .btn-primary{background:#007bff;color:#fff}.btn-primary:hover{background:#0056b3}
    .btn-danger{background:#dc3545;color:#fff}.btn-danger:hover{background:#c82333}
    .btn-info{background:#17a2b8;color:#fff}.btn-info:hover{background:#138496}
    .stats{padding:20px;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;background:#fff3cd;display:none}
    .stat{padding:15px;background:#fff;border-radius:4px;border-left:4px solid #ffc107}
    .stat-label{font-size:11px;color:#6c757d;text-transform:uppercase;margin-bottom:5px}
    .stat-value{font-size:20px;font-weight:700}
    .stat-value.error{color:#dc3545}.stat-value.success{color:#28a745}
    .stat input{width:100%;padding:6px;border:1px solid #ced4da;border-radius:3px;font-size:16px;font-weight:bold}
    .stat.editable{border-left-color:#007bff}
    .table-container{padding:20px;display:none}
    .table-header-wrapper{background:#343a40;overflow:auto}
    .table-header-wrapper::-webkit-scrollbar{display:none}
    .table-header-wrapper{scrollbar-width:none}
    .table-header{min-width:1200px}
    .table-header table{width:100%;border-collapse:collapse}
    .table-header th{background:#343a40;color:#fff;padding:12px 8px;text-align:left;font-weight:600;font-size:13px;border:none}
    .table-body-wrapper{max-height:560px;overflow:auto}
    .table-body{min-width:1200px}
    .table-body table{width:100%;border-collapse:collapse}
    .table-body td{padding:10px 8px;border-bottom:1px solid #dee2e6;background:#fff}
    .table-body tr:hover td{background:#f8f9fa}
    .table-body td input{width:100%;padding:6px;border:1px solid #ced4da;border-radius:3px;font-size:13px}
    .table-body td input:focus{outline:none;border-color:#667eea}
    .readonly{background:#e9ecef!important}
    .actions{text-align:center}
    .actions button{padding:4px 8px;font-size:12px;margin:0 2px}
    .inline-help{font-size:12px;color:#6c757d;margin-left:8px}

    .db-section{padding:20px;background:#e7f3ff;border-bottom:1px solid #b3d9ff}
    .db-status{display:inline-block;padding:5px 10px;border-radius:4px;font-size:12px;margin-left:10px}
    .db-loaded{background:#d4edda;color:#155724}
    .db-loading{background:#fff3cd;color:#856404}
    .db-error{background:#f8d7da;color:#721c24}
    .db-info{font-size:12px;color:#004085;margin-top:5px}
  
    /* === Column alignment + tighter widths === */
    .table-header table, .table-body table{table-layout:fixed}
    /* POS */
    .table-header th:nth-child(1), .table-body td:nth-child(1){width:44px!important}
    /* Part Number */
    .table-header th:nth-child(2), .table-body td:nth-child(2){width:210px!important}
    /* Quantity */
    .table-header th:nth-child(3), .table-body td:nth-child(3){width:80px!important}
    /* Unit */
    .table-header th:nth-child(4), .table-body td:nth-child(4){width:56px!important}
    /* Unit Price */
    .table-header th:nth-child(5), .table-body td:nth-child(5){width:120px!important}
    /* Line Total */
    .table-header th:nth-child(6), .table-body td:nth-child(6){width:120px!important}
    /* Net Weight */
    .table-header th:nth-child(7), .table-body td:nth-child(7){width:96px!important}
    /* Country */
    .table-header th:nth-child(8), .table-body td:nth-child(8){width:64px!important}
    /* Actions */
    .table-header th:nth-child(9), .table-body td:nth-child(9){width:140px!important}

    .table-body td{padding:6px 6px}
    .table-body td input{width:100%;}
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üìÑ Invoice PDF Parser & Editor</h1>
    <p>Steel/Aluminum sublines below each main line. Export-ready.</p>
  </div>

  <div class="db-section" id="dbSection">
    <strong>Database Status:</strong>
    <span class="db-status db-loading" id="dbStatus">Loading database from repository...</span>
    <div class="db-info" id="dbInfo">Fetching updated_manki_db.xlsx from GitHub...</div>
  </div>

  <div class="upload-section" id="uploadSection">
    <div class="upload-box" id="uploadBox">
      <h2>üì§ Upload PDF Invoice</h2>
      <p style="margin-top:10px;color:#6c757d">Click or drag & drop your PDF file here</p>
      <input type="file" id="fileInput" accept=".pdf,application/pdf" />
    </div>
  </div>

  <div class="loading" id="loading">
    <div class="spinner"></div>
    <div><strong>Processing PDF...</strong></div>
  </div>

  <div class="alert" id="alert" style="display:none"></div>

  <div class="controls" id="controls">
    <select id="invoiceSelect"><option value="">Select an invoice...</option></select>
    <button class="btn-warning" onclick="exportToDescartes()">üìã Export to Descartes Template (All Invoices)</button>
    <button class="btn-success" onclick="exportToExcel()">üì• Export All to Excel</button>
    <button class="btn-info" onclick="addBlankRowForCurrent()">‚ûï Add Blank Row</button>
    <button class="btn-primary" onclick="resetUpload()">üì§ New Upload</button>
    <span class="inline-help">Tip: Use <strong>Tab</strong>/<strong>Shift+Tab</strong> or <strong>Enter</strong> to move between fields.</span>
  </div>

  <div class="stats" id="stats">
    <div class="stat"><div class="stat-label">Invoice Number</div><div class="stat-value" id="statInvoice">-</div></div>
    <div class="stat editable"><div class="stat-label">Invoice Date (Editable)</div><input autocomplete="off" type="text" id="statDate" placeholder="MM/DD/YYYY" onchange="updateInvoiceField('invoice_date', this.value)"></div>
    <div class="stat editable"><div class="stat-label">Supplier (Editable)</div><input autocomplete="off" type="text" id="statSupplier" placeholder="Supplier name" onchange="updateInvoiceField('supplier', this.value)"></div>
    <div class="stat"><div class="stat-label">Total Line Items</div><div class="stat-value" id="statItems">0</div></div>
    <div class="stat editable"><div class="stat-label">Invoice Total (Editable)</div><input autocomplete="off" type="number" step="0.01" id="statTotal" placeholder="0.00" onchange="updateInvoiceTotal(this.value)"></div>
    <div class="stat"><div class="stat-label">Line Items Sum</div><div class="stat-value" id="statSum">$0.00</div></div>
    <div class="stat"><div class="stat-label">Difference</div><div class="stat-value" id="statDiff">$0.00</div></div>
  </div>

  <div class="table-container" id="tableContainer">
    <div class="table-header-wrapper">
      <div class="table-header">
        <table><thead><tr>
          <th style="width:48px">Pos</th>
          <th style="width:210px">Part Number</th>
          <th style="width:90px">Quantity</th>
          <th style="width:64px">Unit</th>
          <th style="width:120px">Unit Price</th>
          <th style="width:120px">Line Total</th>
          <th style="width:120px">Net Weight</th>
          <th style="width:80px">Country</th>
          <th style="width:140px">Actions</th>
        </tr></thead></table>
      </div>
    </div>
    <div class="table-body-wrapper">
      <div class="table-body">
        <table><tbody id="tableBody"></tbody></table>
      </div>
    </div>
  </div>
</div>

<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  let allData = [];
  let currentInvoice = '';
  let invoiceOrder = [];
  let uploadedPdfName = '';

  const uploadBox = document.getElementById('uploadBox');
  const fileInput = document.getElementById('fileInput');
  const headerWrap = document.querySelector('.table-header-wrapper');
  const bodyWrap = document.querySelector('.table-body-wrapper');
  if(headerWrap && bodyWrap){
    let syncing=false;
    bodyWrap.addEventListener('scroll',()=>{ if(syncing) return; syncing=true; headerWrap.scrollLeft = bodyWrap.scrollLeft; syncing=false; });
    headerWrap.addEventListener('scroll',()=>{ if(syncing) return; syncing=true; bodyWrap.scrollLeft = headerWrap.scrollLeft; syncing=false; });
  }

  uploadBox.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', e => { const f = e.target.files && e.target.files[0]; if (f) handleFile(f); });
  uploadBox.addEventListener('dragover', e => { e.preventDefault(); uploadBox.classList.add('dragover'); });
  uploadBox.addEventListener('dragleave', () => uploadBox.classList.remove('dragover'));
  uploadBox.addEventListener('drop', e => { e.preventDefault(); uploadBox.classList.remove('dragover'); const f = e.dataTransfer.files && e.dataTransfer.files[0]; if (f) handleFile(f); });

  function isPdfFile(file){ const nameOk=(file.name||'').toLowerCase().endsWith('.pdf'); const typeOk=(file.type||'').toLowerCase()==='application/pdf'; return nameOk || typeOk; }

  function showAlert(msg,type='success'){
    const el=document.getElementById('alert'); el.textContent=msg; el.style.display='block';
    el.style.background = type==='error'?'#f8d7da':'#d4edda';
    el.style.color = type==='error'?'#721c24':'#155724';
    el.style.border = type==='error'?'1px solid #f5c6cb':'1px solid #c3e6cb';
    setTimeout(()=>{ el.style.display='none'; }, 4000);
  }

  async function handleFile(file){
    if(!isPdfFile(file)){ showAlert('Please upload a PDF file','error'); return; }
    uploadedPdfName = (file.name||'').replace(/\.pdf$/i,'');

    document.getElementById('uploadSection').style.display='none';
    document.getElementById('loading').style.display='block';

    try{
      const arrayBuffer = await file.arrayBuffer();
      const uint8 = new Uint8Array(arrayBuffer);
      const pdf = await pdfjsLib.getDocument({data:uint8}).promise;

      let fullText='';
      for(let i=1;i<=pdf.numPages;i++){
        try{
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent({includeMarkedContent:true});
          const items = (textContent && Array.isArray(textContent.items))? textContent.items:[];
          const pageText = items.map(it=> (it && typeof it.str==='string') ? it.str : '').join(' ');
          fullText += (pageText||'') + '\n';
        }catch(perPageErr){ console.warn('Failed to read page',i,perPageErr); }
      }

      if(!fullText.trim()){
        showAlert('‚ö†Ô∏è The PDF had no extractable text (it may be scanned). Try an OCR'd copy.','error');
        document.getElementById('uploadSection').style.display='block';
        return;
      }

      parseInvoices(fullText);

      if(allData.length>0){
        const invoiceCount = new Set(allData.map(d=>d.invoice_number)).size;
        showAlert(`‚úÖ Found ${invoiceCount} invoice(s) with ${allData.length} line items`,'success');
        setupInterface();
      }else{
        showAlert('‚ö†Ô∏è No invoice data found in PDF.','error');
        document.getElementById('uploadSection').style.display='block';
      }
    }catch(err){
      console.error('PDF processing error:',err); showAlert('Error: '+(err.message||String(err)),'error');
      document.getElementById('uploadSection').style.display='block';
    }finally{
      document.getElementById('loading').style.display='none';
    }
  }

  function parseFloatSafe(s){ if(s==null) return NaN; const t=String(s).replace(/[\,\s]/g,''); const v=parseFloat(t); return isNaN(v)?NaN:v; }
  function fmt2(n){ const v=parseFloatSafe(n); return isNaN(v)?'':v.toFixed(2); }

  function parseInvoices(text){
    allData=[]; invoiceOrder=[]; text = String(text||'');

    const splits = text.split(/Customs\s+Invoice\s+(\d+)\s+from/gi);
    const invoiceGroups = {};

    for(let i=1;i<splits.length;i+=2){
      const invoiceNum = splits[i]; const sectionText = splits[i+1];
      if(!invoiceNum || !sectionText) continue;
      if(!invoiceGroups[invoiceNum]){ invoiceOrder.push(invoiceNum); invoiceGroups[invoiceNum]=''; }
      invoiceGroups[invoiceNum] += sectionText + '\n';
    }

    Object.keys(invoiceGroups).forEach(invoiceNum => {
      const sectionText = invoiceGroups[invoiceNum] || '';

      const dateMatch = sectionText.match(/^\s*(\d{2}\/\d{2}\/\d{4})/);
      const invoiceDate = dateMatch ? dateMatch[1] : '';

      const headerSlice = sectionText.substring(0,1200);
      // Try to spot supplier name (loose)
      let supplier='';
      const supplierPattern=/(R√ºdt Industrielacke GmbH & Co\. KG|Norix Lackfabrik GmbH & Co\. KG|Finalin GmbH & Co\. KG|Mankiewicz Coatings, LLC)/i;
      const supplierMatch = headerSlice.match(supplierPattern);
      if(supplierMatch){ supplier = supplierMatch[1].trim(); }

      // Conservative attempt to find an invoice total (fallback editable in UI)
      let invoiceTotal='';
      const overallPattern=/Overall\s+amount\s+in\s+USD\s+([\d,]+\.?\d*)/gi;
      const overallMatches=[...sectionText.matchAll(overallPattern)];
      if(overallMatches.length) invoiceTotal = overallMatches.at(-1)[1].replace(/,/g,'');

      // ==== LINE PARSING ====
      const UNIT_WORD = '(?:carton|bucket(?:s|\\(s\\))?|pail|tin|can|barrel|canister|cartridge|bottle(?:s|\\(s\\))?|piece(?:\\(s\\))?|can(?:\\(s\\))?|pail(?:\\(s\\))?|tin(?:\\(s\\))?|Kilogramme)';

      // With "x ..." form
      const linePatternA = new RegExp(
        String.raw`(\d+)\s+([A-Z0-9.\-]+)\s+([\d,]+\.?\d*)\s+${UNIT_WORD}\s*(?:\([^)]*\)\s*)?` +
        String.raw`x\s*([\d,]+\.?\d+)\s+([A-Z]+)\s+` +
        String.raw`([\d,]+\.?\d+)\s+([A-Z]+)\s+` +
        String.raw`([\d.,]+)\s+USD\/(FOZ|KG|GAL|QT|PT|CN|PC|L|CAT|TIN|BTL|BUC)\s+` +
        String.raw`([\d,]+\.?\d+)`,
        'gi'
      );

      // No "x ..."
      const linePatternB = new RegExp(
        String.raw`(\d+)\s+([A-Z0-9.\-]+)\s+([\d,]+\.?\d*)\s+${UNIT_WORD}\s*` +
        String.raw`([\d,]+\.?\d+)\s+([A-Z]+)\s+` +
        String.raw`([\d.,]+)\s+USD\/(FOZ|KG|GAL|QT|PT|CN|PC|L|CAT|TIN|BTL|BUC)\s+` +
        String.raw`([\d,]+\.?\d+)`,
        'gi'
      );

      const STEEL_ALUM_SUBLINE =
        /(\d+[SA])\s*(?:9903\.81\.91\s*-\s*Steel\s*Packaging|9903\.85\.08\s*-\s*Aluminum\s*Content(?:\s*\(in\s*metallic\s*paint\))?)\s+([\d,]+\.?\d*)\s+(KG)\s+Country\s+of\s+origin\s+([A-Z]{2})\s*product\s+of\s+([A-Z]{2})/gi;

      const foundItems = [];
      let match;
      while((match = linePatternA.exec(sectionText))){
        const pos = match[1], pn = match[2], qty = match[3], xVal = match[4], nwUnit = match[5],
              nwVal = match[6], nwUnit2 = match[7], uprice = match[8], unit = match[9], lTotal = match[10];
        foundItems.push({position:pos,part_number:pn,quantity:qty,net_weight_x:xVal,unit,unit_price:uprice,line_total:lTotal,country_of_origin:'',net_weight:xVal});
      }
      while((match = linePatternB.exec(sectionText))){
        const pos = match[1], pn = match[2], qty = match[3], nwVal = match[4], nwUnit = match[5], uprice = match[6], unit = match[7], lTotal = match[8];
        foundItems.push({position:pos,part_number:pn,quantity:qty,net_weight_x:nwVal,unit,unit_price:uprice,line_total:lTotal,country_of_origin:'',net_weight:nwVal});
      }

      const subItems = [];
      while((match = STEEL_ALUM_SUBLINE.exec(sectionText))){
        const subPos = match[1], subQty = match[2], subUnit = match[3], originCountry = match[4], prodCountry = match[5];
        const type = /S$/i.test(subPos) ? 'STEEL' : 'ALUMINUM';
        subItems.push({position:subPos,part_number:type,quantity:subQty,net_weight:subQty,unit:subUnit,unit_price:'0',line_total:'0',country_of_origin:originCountry});
      }

      const merged = [];
      foundItems.forEach(item => { merged.push(item); });
      subItems.forEach(sub => {
        const base = String(sub.position||'').replace(/[SA]$/i,'');
        const idx = merged.findIndex(x => x.position === base);
        if (idx >= 0) merged.splice(idx + 1, 0, sub);
        else merged.push(sub);
      });

      merged.forEach(item => {
        allData.push({
          invoice_number: invoiceNum,
          invoice_date: invoiceDate,
          invoice_total: invoiceTotal,
          supplier: supplier,
          ...item
        });
      });
    });

    console.log('Parsed data:', allData);
  }

  function setupInterface(){
    document.getElementById('controls').style.display='flex';
    document.getElementById('stats').style.display='grid';
    document.getElementById('tableContainer').style.display='block';
    const sel = document.getElementById('invoiceSelect'); sel.innerHTML='<option value="">Select an invoice...</option>';
    invoiceOrder.forEach(inv=>{ const opt=document.createElement('option'); opt.value=inv; opt.textContent=`Invoice ${inv}`; sel.appendChild(opt); });
    sel.onchange = () => { currentInvoice = sel.value; renderTable(); };
    if(invoiceOrder.length>0){ currentInvoice = invoiceOrder[0]; sel.value=currentInvoice; renderTable(); }
  }

  function renderTable(){
    if(!currentInvoice){ return; }
    const items = allData.filter(d => d.invoice_number === currentInvoice);
    if(!items.length){ return; }

    const tbody = document.getElementById('tableBody');
    tbody.innerHTML='';

    items.forEach((item, idx) => {
      const row = tbody.insertRow();
      const isSA = /[SA]$/i.test(String(item.position||''));
      const makeCell = (val,editable=false,readonly=false) => {
        const td = row.insertCell();
        if(editable && !readonly){
          const inp = document.createElement('input'); inp.type='text'; inp.value=val||'';
          inp.addEventListener('keydown', e => {
            if(e.key==='Enter'||e.key==='Tab'){
              if(!e.shiftKey && inp.selectionStart===inp.value.length) focusNextInput(inp);
              else if(e.shiftKey) focusPrevInput(inp);
            }
          });
          td.appendChild(inp);
        } else {
          td.textContent=val||''; if(readonly) td.classList.add('readonly');
        }
        return td;
      };
      const cellPos = makeCell(item.position, false, true);
      const cellPN = makeCell(item.part_number, true, isSA);
      const cellQty = makeCell(item.quantity, true);
      const cellUnit = makeCell(item.unit, true);
      const cellPrice = makeCell(item.unit_price, true);
      const cellTotal = makeCell(item.line_total, true);
      const cellWeight = makeCell(item.net_weight, true);
      const cellCountry = makeCell(item.country_of_origin, true);

      cellPos.querySelector('input, td').oninput = function(){ item.position = this.value; };
      if(!isSA) cellPN.querySelector('input, td').oninput = function(){ item.part_number = this.value; };
      cellQty.querySelector('input, td').oninput = function(){ item.quantity = this.value; recomputeTotals(); };
      cellUnit.querySelector('input, td').oninput = function(){ item.unit = this.value; };
      cellPrice.querySelector('input, td').oninput = function(){ item.unit_price = this.value; recomputeTotals(); };
      cellTotal.querySelector('input, td').oninput = function(){ item.line_total = this.value; recomputeTotals(); };
      cellWeight.querySelector('input, td').oninput = function(){ item.net_weight = this.value; };
      cellCountry.querySelector('input, td').oninput = function(){ item.country_of_origin = this.value; };

      const actCell = row.insertCell(); actCell.classList.add('actions');
      const dupBtn = document.createElement('button'); dupBtn.textContent='Duplicate'; dupBtn.className='btn-info'; dupBtn.onclick = () => duplicateLine(item);
      const delBtn = document.createElement('button'); delBtn.textContent='Delete'; delBtn.className='btn-danger'; delBtn.onclick = () => deleteLine(idx);
      actCell.appendChild(dupBtn); actCell.appendChild(delBtn);
    });

    recomputeTotals();
  }

  function duplicateLine(item){
    const items = allData.filter(d => d.invoice_number === currentInvoice);
    const idx = items.indexOf(item);
    if (idx < 0) return;
    const copy = {...item};
    allData.splice(allData.indexOf(item) + 1, 0, copy);
    renderTable();
  }

  function deleteLine(idx){
    const items = allData.filter(d => d.invoice_number === currentInvoice);
    const globalIndex = allData.indexOf(items[idx]);
    if (globalIndex < 0) return;
    allData.splice(globalIndex, 1);
    renderTable();
  }

  function focusNextInput(current){ const all=document.querySelectorAll('#tableBody input'); const i=Array.from(all).indexOf(current); if (i>=0 && i<all.length-1) all[i+1].focus(); }
  function focusPrevInput(current){ const all=document.querySelectorAll('#tableBody input'); const i=Array.from(all).indexOf(current); if (i>0) all[i-1].focus(); }

  function recomputeTotals(){
    const items = allData.filter(d => d.invoice_number === currentInvoice);
    const totalSet = new Set(items.map(i=>i.invoice_total).filter(x=>x));
    const invoiceTotal = totalSet.size===1 ? [...totalSet][0] : '';
    const lineSum = items.reduce((acc, item) => {
      const lt = parseFloatSafe(item.line_total);
      return acc + (isNaN(lt) ? 0 : lt);
    }, 0);
    const invVal = parseFloatSafe(invoiceTotal);
    const diff = isNaN(invVal) ? 0 : (invVal - lineSum);

    document.getElementById('statInvoice').textContent = currentInvoice||'-';
    document.getElementById('statDate').value = (items[0]?.invoice_date||'');
    document.getElementById('statSupplier').value = (items[0]?.supplier||'');
    document.getElementById('statItems').textContent = items.length;
    document.getElementById('statTotal').value = invoiceTotal;
    document.getElementById('statSum').textContent = '$' + lineSum.toFixed(2);
    const diffEl = document.getElementById('statDiff'); diffEl.textContent = '$' + diff.toFixed(2);
    diffEl.className = 'stat-value ' + (Math.abs(diff)<0.01?'success':'error');
  }

  function updateInvoiceTotal(val){
    allData.forEach(d => { if(d.invoice_number===currentInvoice) d.invoice_total=val; });
    renderTable();
  }

  function updateInvoiceField(field, val){
    allData.forEach(d => { if(d.invoice_number===currentInvoice) d[field]=val; });
    renderTable();
  }

  function addBlankRowForCurrent(){
    if(!currentInvoice){ showAlert('Select an invoice first','error'); return; }
    const items = allData.filter(d => d.invoice_number === currentInvoice);
    const lastPos = items.length>0 ? (parseInt(items[items.length-1].position)||0) : 0;
    const newRow = {
      invoice_number: currentInvoice,
      invoice_date: items[0]?.invoice_date || '',
      invoice_total: items[0]?.invoice_total || '',
      supplier: items[0]?.supplier || '',
      position: String(lastPos+1),
      part_number: '',
      quantity: '',
      unit: 'KG',
      unit_price: '',
      line_total: '',
      net_weight: '',
      country_of_origin: ''
    };
    allData.push(newRow);
    renderTable();
  }

  function exportToExcel(){
    if(!allData.length){ showAlert('No data to export','error'); return; }
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(allData);
    XLSX.utils.book_append_sheet(wb, ws, 'All Data');
    const out = XLSX.write(wb, {type:'array', bookType:'xlsx'});
    const blob = new Blob([out], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = (uploadedPdfName?uploadedPdfName+'_':'')+'parsed_invoices.xlsx';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showAlert('All data exported successfully!', 'success');
  }

  function resetUpload(){
    allData=[]; invoiceOrder=[]; currentInvoice=''; uploadedPdfName='';
    document.getElementById('controls').style.display='none';
    document.getElementById('stats').style.display='none';
    document.getElementById('tableContainer').style.display='none';
    document.getElementById('uploadSection').style.display='block';
    document.getElementById('tableBody').innerHTML='';
  }

  // ========================================
  // DATABASE + TARIFF LOOKUP
  // ========================================
  
  let mankiDb = null;
  let htsCodesDb = null;
  let steelAlumDb = null;
  let midDb = null;  // NEW: MID database

  const GITHUB_CONFIG = {
    owner: 'iffinc-ga',
    repo: 'all_in_one_manki',
    branch: 'main',
    filePath: 'updated_manki_db.xlsx'
  };

  window.addEventListener('DOMContentLoaded', function() {
    loadDatabaseFromGitHub();
  });

  async function loadDatabaseFromGitHub() {
    const { owner, repo, branch, filePath } = GITHUB_CONFIG;
    const dbUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${filePath}`;
    
    document.getElementById('dbStatus').textContent = 'Loading database...';
    document.getElementById('dbStatus').className = 'db-status db-loading';
    document.getElementById('dbInfo').textContent = `Fetching from: ${dbUrl}`;

    try {
      const response = await fetch(dbUrl);
      if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);

      const arrayBuffer = await response.arrayBuffer();
      const data = new Uint8Array(arrayBuffer);
      const workbook = XLSX.read(data, {type:'array'});
      
      if(workbook.SheetNames.includes('UPDATED_MANKI_DB')){
        mankiDb = XLSX.utils.sheet_to_json(workbook.Sheets['UPDATED_MANKI_DB']);
      } else throw new Error('UPDATED_MANKI_DB sheet not found');
      
      if(workbook.SheetNames.includes('manki_hts_codes_with_uom')){
        htsCodesDb = XLSX.utils.sheet_to_json(workbook.Sheets['manki_hts_codes_with_uom']);
      } else throw new Error('manki_hts_codes_with_uom sheet not found');
      
      if(workbook.SheetNames.includes('Sheet1')){
        steelAlumDb = XLSX.utils.sheet_to_json(workbook.Sheets['Sheet1']);
      } else throw new Error('Sheet1 not found');
      
      // NEW: Load MID tab
      if(workbook.SheetNames.includes('MID')){
        midDb = XLSX.utils.sheet_to_json(workbook.Sheets['MID']);
        console.log('MID database loaded:', midDb);
      } else {
        console.warn('MID sheet not found in database');
        midDb = [];
      }
      
      document.getElementById('dbStatus').textContent = `Database loaded ‚úì (${mankiDb.length} parts, ${htsCodesDb.length} HTS, ${steelAlumDb.length} mappings, ${midDb.length} MIDs)`;
      document.getElementById('dbStatus').className = 'db-status db-loaded';
      document.getElementById('dbInfo').textContent = `Loaded: ${new Date().toLocaleString()} | Source: GitHub Repository`;
      console.log('Database loaded successfully');
    } catch(err) {
      console.error('Database load error:', err);
      document.getElementById('dbStatus').textContent = 'Database load failed ‚úó';
      document.getElementById('dbStatus').className = 'db-status db-error';
      document.getElementById('dbInfo').innerHTML = `<strong>Error:</strong> ${err.message}<br><strong>Fix:</strong> Update GITHUB_CONFIG in HTML file`;
    }
  }

  // NEW: Function to find supplier MID based on partial name match
  function findSupplierMID(supplierName) {
    if (!midDb || !midDb.length || !supplierName) return '';
    
    const searchName = String(supplierName).toLowerCase().trim();
    
    // Try to find a match by checking if any part of the MANUFACTURERNAME contains the supplier name
    // or if the supplier name contains any significant part of the MANUFACTURERNAME
    for (const row of midDb) {
      const manufacturerName = String(row.MANUFACTURERNAME || '').toLowerCase().trim();
      const manufacturerMID = String(row.MANUFACTURERMID || '').trim();
      
      if (!manufacturerName || !manufacturerMID) continue;
      
      // Split both names into words and check for significant word matches
      const searchWords = searchName.split(/[\s\-.,&]+/).filter(w => w.length > 2);
      const mfgWords = manufacturerName.split(/[\s\-.,&]+/).filter(w => w.length > 2);
      
      // Check if any significant word from search matches any word in manufacturer name
      for (const searchWord of searchWords) {
        for (const mfgWord of mfgWords) {
          if (mfgWord.includes(searchWord) || searchWord.includes(mfgWord)) {
            console.log(`MID Match found: "${supplierName}" -> "${row.MANUFACTURERNAME}" -> ${manufacturerMID}`);
            return manufacturerMID;
          }
        }
      }
    }
    
    console.log(`No MID match found for supplier: "${supplierName}"`);
    return '';
  }

  // === Base 4‚Äì5 char part number extractor for main lines ===
  function extractBasePartNumber(fullPartNum){
    const s = String(fullPartNum || '').trim();
    const head = s.split('.')[0];                  // text before first dot
    const alnum = (head.match(/[A-Za-z0-9]+/)||[''])[0];
    if (alnum.length >= 5) return alnum.slice(0,5);
    if (alnum.length === 4) return alnum;          // allow 4-char base
    const fallback = (s.match(/[A-Za-z0-9]{4,5}/)||[''])[0];
    return fallback || alnum || '';
  }

  function lookupTariffs(basePartNum){
    if(!mankiDb) return [];
    const part = mankiDb.find(row => String(row['PRIMARY PART NUM']) === basePartNum);
    if(!part) return [];
    const codes = [];
    for(let i=1;i<=5;i++){
      const code = part[`HTS ${i}`];
      if(code){ codes.push(String(code)); }
    }
    return codes;
  }

  function lookupHtsUom(tariffCode){
    if(!htsCodesDb) return {uom1:'', uom2:''};
    const htsRow = htsCodesDb.find(row => String(row['HTS Code']).startsWith(String(tariffCode)));
    if(!htsRow) return {uom1:'', uom2:''};
    return {
      uom1: htsRow['UoM 1']||'',
      uom2: htsRow['UoM 2']||''
    };
  }

  function getSteelAlumPartNumber(htsCode, materialType){
    if(!steelAlumDb) return materialType==='Steel'?'STEEL GENERIC':'ALUM GENERIC';
    const rec = steelAlumDb.find(r =>
      String(r['HTS Code']||'').trim() === String(htsCode||'').trim() &&
      String(r['Material Type']||'').toLowerCase() === materialType.toLowerCase()
    );
    return rec ? (rec['Part Number']||'STEEL GENERIC') : (materialType==='Steel'?'STEEL GENERIC':'ALUM GENERIC');
  }

  // ========================================
  // EXPORT TO DESCARTES TEMPLATE
  // ========================================
  function exportToDescartes(){
    if(!mankiDb){ showAlert('Database not loaded yet. Please wait for it to load from GitHub.','error'); return; }
    if(!allData.length){ showAlert('No data to export','error'); return; }

    const roundWeight = (val) => {
      const num = parseFloatSafe(val);
      if(isNaN(num)) return '';
      return num.toFixed(2);
    };

    const exportRows = [];
    const items = allData;

    items.forEach((item, index) => {
      const isSteelLine = String(item.position||'').endsWith('S') || item.part_number === 'STEEL';
      const isAlumLine  = String(item.position||'').endsWith('A') || item.part_number === 'ALUMINUM';

      // === Buyer/Supplier part number logic ===
      let buyerPartNum, supplierPartNum;
      if (!isSteelLine && !isAlumLine) {
        const basePart = extractBasePartNumber(item.part_number);
        buyerPartNum = basePart;
        supplierPartNum = basePart;
      } else {
        const parentPos = String(item.position||'').replace(/[SA]$/,'');
        const parentItem = items.find(it => it.invoice_number===item.invoice_number && it.position === parentPos);
        let tariffForSubline = null;
        if (parentItem) {
          const parentBase = extractBasePartNumber(parentItem.part_number);
          const parentTariffs = lookupTariffs(parentBase);
          tariffForSubline = parentTariffs.find(t => !String(t).startsWith('98') && !String(t).startsWith('99')) || null;
        }
        const subNum = tariffForSubline
          ? getSteelAlumPartNumber(tariffForSubline, isSteelLine ? 'Steel' : 'Aluminum')
          : (isSteelLine ? 'STEEL GENERIC' : 'ALUM GENERIC');
        buyerPartNum = subNum;
        supplierPartNum = subNum;
      }

      // NEW: Find SupplierMID using partial match
      const supplierMID = findSupplierMID(item.supplier);

      // Build Descartes row
      const row = {
        'InvoiceNumber': item.invoice_number,
        'InvoiceDate': item.invoice_date,
        'InvoiceTotal': item.invoice_total,
        'SupplierMID': supplierMID,  // NEW: Populated with matched MID
        'SupplierName': item.supplier,
        'BuyerPartNumber': buyerPartNum,
        'SupplierPartNumber': supplierPartNum,
        'Quantity': item.quantity,
        'UnitOfMeasure': item.unit,
        'Description': '',
        'UnitPrice': item.unit_price,
        'ItemTotal': item.line_total,
        'CurrencyCode': '',
        'ExchangeRate': '',
        'CountryOfOrigin': item.country_of_origin,
        'CountryOfExport': '',
        'DateOfExport': '',
        'PortOfLading': '',
        'RelatedParty': '',
        'PO_Number': '',
        'PO_Date': '',
        'GrossWeight': '',
        'GrossWeightUnit': '',
        'NetWeight': roundWeight(item.net_weight),
        'TariffNumber': '',
        'TariffDescription': '',
        'Quantity1': '',
        'UnitOfMeasure1': '',
        'Quantity2': '',
        'UnitOfMeasure2': '',
        'Quantity3': '',
        'UnitOfMeasure3': '',
        'PrimarySPI': '',
        'SecondarySPI': '',
        'DeliverTo': '',
        'SoldTo': '',
        'SellerMID': '',
        'ShipperMID': '',
        'EntryDate': '',
        'ArrivalDate': '',
        'Carrier': '',
        'Vessel': '',
        'Voyage': '',
        'PortOfEntry': '',
        'PortOfUnloading': '',
        'LocationCode': '',
        'TotalCharges': '',
        'BillOfLadingNumber': '',
        'Container': '',
        'SecondaryTariffNumber': '',
        'SecondaryTariffdescription': '',
        'Secondary Quantity1': '',
        'Secondaryunitofmeasure1': '',
        'secondaryquantity2': '',
        'secondaryunitofmeasure2': '',
        'secondaryquantity3': '',
        'secondaryunitofmeasure3': '',
        'secondaryvalue': '',
        'FTZStatus': '',
        'FTZPrivilegedDate\u00a0': '',
        'ThirdTariffNumber': '',
        'ThirdTariffDescription': '',
        'ThirdTariffQuantity1': '',
        'ThirdTariffUnitofMeasure1': '',
        'ThirdTariffQuantity2': '',
        'ThirdTariffUnitofMeasure2': '',
        'ThirdTariffQuantity3': '',
        'ThirdTariffUnitofMeasure3': '',
        'Third Value': '',
        '4TariffNumber': '',
        '4TariffDescription': '',
        '4TariffQuantity1': '',
        '4TariffUnitofMeasure1': '',
        '4TariffQuantity2': '',
        '4TariffUnitofMeasure2': '',
        '4TariffQuantity3': '',
        '4TariffUnitofMeasure3': '',
        '4 Value': '',
        '5TariffNumber': '',
        '5TariffDescription': '',
        '5TariffQuantity1': '',
        '5TariffUnitofMeasure1': '',
        '5TariffQuantity2': '',
        '5TariffUnitofMeasure2': '',
        '5TariffQuantity3': '',
        '5TariffUnitofMeasure3': '',
        '5 Value': ''
      };

      // For S/A sublines: mirror displayed Quantity into NetWeight as requested
      if (isSteelLine || isAlumLine) {
        row['NetWeight'] = roundWeight(item.quantity);
      }

      const basePartNum = extractBasePartNumber(item.part_number);
      const tariffs = lookupTariffs(basePartNum);

      const tariffFields = ['TariffNumber', 'SecondaryTariffNumber', 'ThirdTariffNumber', '4TariffNumber', '5TariffNumber'];
      tariffs.forEach((tariff, idx) => {
        if(idx < tariffFields.length){
          row[tariffFields[idx]] = tariff;
          const startsWithExempt = String(tariff).startsWith('98') || String(tariff).startsWith('99');
          if(!startsWithExempt){
            const uomInfo = lookupHtsUom(tariff);
            if(idx === 0){
              row['Quantity1'] = roundWeight(item.net_weight);
              row['UnitOfMeasure1'] = uomInfo.uom1;
              if(uomInfo.uom2){ row['Quantity2'] = roundWeight(item.net_weight); row['UnitOfMeasure2'] = uomInfo.uom2; }
            } else if(idx === 1){
              row['Secondary Quantity1'] = roundWeight(item.net_weight);
              row['Secondaryunitofmeasure1'] = uomInfo.uom1;
              if(uomInfo.uom2){ row['secondaryquantity2'] = roundWeight(item.net_weight); row['secondaryunitofmeasure2'] = uomInfo.uom2; }
            } else if(idx === 2){
              row['ThirdTariffQuantity1'] = roundWeight(item.net_weight);
              row['ThirdTariffUnitofMeasure1'] = uomInfo.uom1;
              if(uomInfo.uom2){ row['ThirdTariffQuantity2'] = roundWeight(item.net_weight); row['ThirdTariffUnitofMeasure2'] = uomInfo.uom2; }
            } else if(idx === 3){
              row['4TariffQuantity1'] = roundWeight(item.net_weight);
              row['4TariffUnitofMeasure1'] = uomInfo.uom1;
              if(uomInfo.uom2){ row['4TariffQuantity2'] = roundWeight(item.net_weight); row['4TariffUnitofMeasure2'] = uomInfo.uom2; }
            } else if(idx === 4){
              row['5TariffQuantity1'] = roundWeight(item.net_weight);
              row['5TariffUnitofMeasure1'] = uomInfo.uom1;
              if(uomInfo.uom2){ row['5TariffQuantity2'] = roundWeight(item.net_weight); row['5TariffUnitofMeasure2'] = uomInfo.uom2; }
            }
          }
        }
      });

      // For steel lines: add specific tariff and quantity data
      if (isSteelLine) {
        row['TariffNumber'] = '99030133';
        row['SecondaryTariffNumber'] = '99038191';
        row['Secondary Quantity1'] = roundWeight(item.quantity);
        row['Secondaryunitofmeasure1'] = 'KG';
      }

      // For aluminum lines: add specific tariff and quantity data
      if (isAlumLine) {
        row['TariffNumber'] = '99030133';
        row['SecondaryTariffNumber'] = '99038508';
        row['Secondary Quantity1'] = roundWeight(item.quantity);
        row['Secondaryunitofmeasure1'] = 'KG';
      }

      exportRows.push(row);
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(exportRows);
    XLSX.utils.book_append_sheet(wb, ws, 'Descartes Export');
    
    const out = XLSX.write(wb, {type:'array', bookType:'xlsx'});
    const blob = new Blob([out], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = (uploadedPdfName?uploadedPdfName+'_':'')+'descartes_export.xlsx';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showAlert('Descartes template exported successfully!', 'success');
  }
</script>

<!-- ==== Runtime "no-UI-change" patch: normalize only when needed ==== -->
<script>
(function(){
  function normalizeWeirdSpacing(s){
    const esc = (ch)=>ch.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
    const squish = (word)=>{
      const pat = new RegExp(word.split('').map(esc).join('\\s*'),'ig');
      return (txt)=>txt.replace(pat, word);
    };
    const common = [
      'Steel','Aluminum','Packaging','Content','Quantity','per','PCS',
      'Total','net','weight','value','customs','KG','invoice','Country','origin','product'
    ];
    let out = String(s);
    for(const w of common){ out = squish(w)(out); }
    out = out
      .replace(/9903\.81\.91\s*-\s*S\s*t\s*e\s*e\s*l\s*\s*P\s*a\s*c\s*k\s*a\s*g\s*i\s*n\s*g/ig, '9903.81.91 - Steel Packaging')
      .replace(/9903\.85\.08\s*-\s*A\s*l\s*u\s*m\s*i\s*n\s*u\s*m\s*\s*C\s*o\s*n\s*t\s*e\s*n\s*t(?:\s*\(in\s*metallic\s*paint\))?/ig, '9903.85.08 - Aluminum Content (in metallic paint)');
    out = out
      .replace(/Total\s+net\s+steel\s+weight\s*(?:per\s*KG)?\s*:/ig, 'Total net steel weight per KG:')
      .replace(/Total\s+net\s+aluminum\s+weight\s*(?:per\s*KG)?\s*:/ig, 'Total net aluminum weight per KG:')
      .replace(/Steel\s*content\s*per\s*PCS\s*:/ig, 'Steel content per PCS:')
      .replace(/Aluminum\s*content\s*per\s*PCS\s*:/ig, 'Aluminum content per PCS:')
      .replace(/Quantity\s*per\s*PCS\s*:/ig, 'Quantity per PCS:')
      .replace(/Total\s+customs\s+value\s*:/ig, 'Total customs value:');
    out = out.replace(/(\bKG)\s*\/\s*[0-9][0-9.,]*\s*USD\b/ig, '$1');
    out = out.replace(/\s{2,}/g, ' ');
    return out;
  }

  const needNorm = (re)=>{
    if(!(re instanceof RegExp)) return false;
    const src = (re.source || '').toLowerCase();
    return /9903|steel|alum|customs\s+value|quantity\s*per\s*pcs|content\s*per\s*pcs|total\s+net\s+.*weight/.test(src);
  };

  const _origMatch = String.prototype.match;
  Object.defineProperty(String.prototype, '__origMatch', { value: _origMatch, configurable: true });

  String.prototype.match = function(re){
    try{
      if(needNorm(re)){
        const norm = normalizeWeirdSpacing(String(this));
        return _origMatch.call(norm, re);
      }
      return _origMatch.call(this, re);
    }catch(e){
      return _origMatch.call(this, re);
    }
  };
})();
</script>

<!-- === Steel-first ordering for both UI and export (no UI changes) === -->
<script>
(function(){
  function _rowInfo(row){
    const inv = String(row.invoice_number || '').trim();
    const pos = String(row.position || '').trim();
    const base = pos.replace(/[SA]$/i, '');
    let ord = 0;
    if (/S$/i.test(pos)) ord = 1;
    else if (/A$/i.test(pos)) ord = 2;
    return { group: inv + '||' + base, ord };
  }

  function reorderSteelAlum(arr){
    if (!Array.isArray(arr) || arr.length === 0) return arr;
    const groupMap = new Map();
    arr.forEach((r, idx) => {
      const { group, ord } = _rowInfo(r);
      if (!groupMap.has(group)) groupMap.set(group, []);
      groupMap.get(group).push({ r, idx, ord });
    });
    const out = [];
    const used = new Set();
    arr.forEach((r, idx) => {
      if (used.has(idx)) return;
      const { group } = _rowInfo(r);
      const bucket = groupMap.get(group);
      if (!bucket) { out.push(r); return; }
      bucket.sort((a, b) => (a.ord - b.ord) || (a.idx - b.idx));
      bucket.forEach(({ r: row, idx: i }) => { out.push(row); used.add(i); });
      groupMap.delete(group);
    });
    arr.length = 0;
    Array.prototype.push.apply(arr, out);
    return arr;
  }

  function detectDataArray(){
    const candidates = [];
    for (const k in window){
      try{
        const v = window[k];
        if (Array.isArray(v) && v.length && typeof v[0] === 'object'){
          const keys = Object.keys(v[0]);
          if (keys.includes('invoice_number') && keys.includes('position')){
            candidates.push({name:k, ref:v});
          }
        }
      }catch(_){ }
    }
    candidates.sort((a,b)=> (b.ref.length||0) - (a.ref.length||0));
    return candidates[0] || null;
  }

  function proxyWithAutoReorder(arr){
    const mutating = new Set(['push','pop','shift','unshift','splice','sort','reverse']);
    return new Proxy(arr, {
      get(target, prop, recv){
        const val = Reflect.get(target, prop, recv);
        if (typeof val === 'function' && mutating.has(prop)){
          return function(){
            const out = Array.prototype[prop].apply(target, arguments);
            try { reorderSteelAlum(target); } catch(e){}
            return out;
          };
        }
        return val;
      },
      set(target, prop, value, recv){
        const ok = Reflect.set(target, prop, value, recv);
        if (prop === 'length' || /^\d+$/.test(String(prop))){
          try { reorderSteelAlum(target); } catch(e){}
        }
        return ok;
      }
    });
  }

  function hookRenderIfPresent(){
    const names = ['renderTable','drawTable','buildTable','updateTable'];
    names.forEach(n=>{
      if (typeof window[n] === 'function'){
        const _f = window[n];
        window[n] = function(){
          try { if (window.__dataArrayRef) reorderSteelAlum(window.__dataArrayRef); } catch(e){}
          return _f.apply(this, arguments);
        };
      }
    });
  }

  const found = detectDataArray();
  if (found){
    window.__dataArrayName = found.name;
    window.__dataArrayRef  = found.ref;
    const proxied = proxyWithAutoReorder(found.ref);
    try { window[found.name] = proxied; } catch(_){ }
    try { reorderSteelAlum(window.__dataArrayRef); } catch(e){}
    hookRenderIfPresent();
    document.addEventListener('click', (e)=>{
      const id = (e.target && e.target.id || '').toLowerCase();
      if (id.includes('export')) {
        try { reorderSteelAlum(window.__dataArrayRef); } catch(_){ }
      }
    }, true);
  }
})();
</script>

</body>
</html>
