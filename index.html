<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invoice Parser ‚Äî Steel/Aluminum Sublines</title>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root{--bg:#f6f7fb;--card:#fff;--muted:#6b7280;--accent:#4f46e5;--ok:#16a34a;--info:#0ea5e9;--err:#991b1b}
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);margin:0;padding:24px;color:#111}
    .container{max-width:1280px;margin:auto;background:var(--card);border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:20px}
    h1{margin:0 0 8px;font-weight:700}
    .sub{color:var(--muted);margin:0 0 16px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .upload-box{border:2px dashed #bfc6d6;background:#fbfcff;padding:28px;border-radius:12px;display:flex;align-items:center;justify-content:center;gap:10px;cursor:pointer}
    .upload-box.dragover{background:#eef2ff;border-color:var(--accent)}
    button{border:0;border-radius:8px;padding:10px 14px;cursor:pointer;font-weight:600}
    .btn-info{background:var(--info);color:#fff}
    .btn-success{background:var(--ok);color:#fff}
    .btn-ghost{background:#eef2ff;color:#111}
    .alert{margin-top:10px;padding:10px 12px;border-radius:8px;display:none}
    .alert.ok{background:#dcfce7;color:#065f46}
    .alert.err{background:#fee2e2;color:var(--err)}

    .table-wrap{margin-top:16px;border:1px solid #e5e7eb;border-radius:10px;overflow:auto;max-height:60vh}
    table{min-width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:#f3f4f6;border-bottom:1px solid #e5e7eb;font-weight:700}
    th,td{padding:8px 10px;border-right:1px solid #e5e7eb;vertical-align:top}
    th:last-child,td:last-child{border-right:0}
    /* compact columns requested */
    th.pos,td.pos{width:58px}
    th.qty,td.qty{width:80px}
    th.unit,td.unit{width:80px}
    th.net,td.net{width:90px}
    th.country,td.country{width:120px}
    .number{text-align:right}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <h1>üìÑ Invoice PDF Parser & Export</h1>
    <p class="sub">Parses Mankiewicz invoices, inserts 10S/10A sublines, and exports to Descartes OneView.</p>

    <div id="uploadBox" class="upload-box" title="Click or drag a PDF here">
      <strong>Click or drag a PDF here</strong>
      <input type="file" id="fileInput" accept="application/pdf,.pdf" hidden>
    </div>
    <div id="alert" class="alert"></div>

    <div class="row" style="margin-top:12px">
      <button id="loadTplBtn" class="btn-info">üìÑ Load OneView Template</button>
      <input type="file" id="tplInput" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" hidden>
      <button id="loadDbBtn" class="btn-info">üìö Load updated_manki_db.xlsx</button>
      <input type="file" id="dbInput" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" hidden>
      <button id="exportBtn" class="btn-success">üì• Export to OneView</button>
      <button id="clearBtn" class="btn-ghost">‚ôªÔ∏è Clear</button>
    </div>

    <div class="table-wrap">
      <table id="invoiceTable" style="display:none">
        <thead>
          <tr>
            <th class="pos">POS</th>
            <th>Part Number</th>
            <th class="qty">Qty</th>
            <th class="unit">Unit</th>
            <th class="number">Unit Price</th>
            <th class="number">Line Total</th>
            <th class="net">Net Weight</th>
            <th class="country">Country of Origin</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

<script>
  // ===================== GLOBAL STATE =====================
  let allData = [];
  let currentInvoice = '';
  let uploadedPdfName = '';
  let oneViewTemplateWB = null;
  let mankiDbWB = null;

  // Lookups built from updated_manki_db.xlsx
  let htsUomMap = {};          // { '3911902500': {uom1:'KG', uom2:''} }
  let partTariffsMap = {};     // { '40586': ['99030132','3911902500', ...] }
  let steelPartByTariff = {};  // { '3911902500': {part:'STEEL 40586', supplier:'...'} }
  let alumPartByTariff  = {};  // { '3208100000': {part:'ALUM 40586',  supplier:'...'} }
  let genericSteelPart = 'STEEL GENERIC';
  let genericAlumPart  = 'ALUMINUM GENERIC';

  // ===================== UI HELPERS =====================
  function showAlert(msg,type='ok'){
    const el = document.getElementById('alert');
    el.textContent = msg; el.style.display='block'; el.className = 'alert ' + (type==='error'?'err':'ok');
  }
  function fmt(n){ if(n===null||n===undefined||n==='') return ''; const x=Number(n); return Number.isFinite(x)? x.toFixed(2): String(n); }
  function getPartCore(part){
    if(!part) return '';
    const s = String(part);
    const pre = s.split(/[.\-\s]/)[0];
    if(pre.length>=4 && pre.length<=6) return pre.replace(/[^A-Za-z0-9]/g,'');
    const m = s.match(/([A-Za-z0-9]{4,6})/);
    return m? m[1] : pre.replace(/[^A-Za-z0-9]/g,'').slice(0,6);
  }

  // ===================== PDF UPLOAD =====================
  const uploadBox = document.getElementById('uploadBox');
  const fileInput = document.getElementById('fileInput');
  uploadBox.addEventListener('click', ()=> fileInput.click());
  uploadBox.addEventListener('dragover', e=>{ e.preventDefault(); uploadBox.classList.add('dragover'); });
  uploadBox.addEventListener('dragleave', ()=> uploadBox.classList.remove('dragover'));
  uploadBox.addEventListener('drop', e=>{ e.preventDefault(); uploadBox.classList.remove('dragover'); const f=e.dataTransfer.files?.[0]; if(f) handlePdfFile(f); });
  fileInput.addEventListener('change', e=>{ const f=e.target.files?.[0]; if(f) handlePdfFile(f); });

  async function handlePdfFile(file){
    try{
      uploadedPdfName = file.name;
      showAlert('Reading '+file.name+' ...');
      const text = await extractPdfText(file);
      processPDFText(text);
    }catch(err){ console.error(err); showAlert('Failed to read PDF: '+(err.message||err),'error'); }
  }

  async function extractPdfText(file){
    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data:buf}).promise;
    let full='';
    for(let p=1;p<=pdf.numPages;p++){
      const page = await pdf.getPage(p);
      const txt = await page.getTextContent();
      const pageStr = txt.items.map(it=>it.str).join('\n');
      full += `\n\n=====PAGE ${p}=====\n` + pageStr;
    }
    return full;
  }

  // ===================== PARSERS =====================
  function norm(s){return String(s||'').replace(/\u00A0/g,' ').replace(/\s+/g,' ').trim();}
  function find(re, s){const m = s.match(re); return m? (m[1]||m[0]) : '';}

  function parseInvoiceHeader(text){
    const invoice_number = find(/Invoice\s*(?:No\.|Number)\s*[:#]?\s*([A-Z0-9\-]+)/i, text) || find(/INVOICE\s*([0-9]{6,})/i, text);
    const invoice_date = find(/Date\s*[:]?\\s*([0-9]{1,2}[\/\-][0-9]{1,2}[\/\-][0-9]{2,4})/i, text);
    const supplier = norm(find(/^(.*?Mankiewicz[\s\S]*?)\bDate\b/i, text)) || norm(find(/^(.+?)\n/, text));
    const invoice_total = find(/Total\s+Amount\s*[:]?\\s*([0-9.,]+)/i, text) || find(/Invoice\s*Total\s*[:]?\\s*([0-9.,]+)/i, text);
    return {invoice_number, invoice_date, supplier, invoice_total: invoice_total? Number(invoice_total.replace(/,/g,'')) : ''};
  }

  // Pull Steel (9903.81.91) & Aluminum (9903.85.08) block
  function parseSteelAluminumBlock(text){
    const block = { steel:null, alum:null };
    // Steel
    const steelKgRe = /9903[\.-]?81[\.-]?91[\s\S]*?Total\s+net\s+steel\s+weight\s+per\s+KG:\s*([0-9.,]+)/i;
    const steelValRe = /9903[\.-]?81[\.-]?91[\s\S]*?Total\s+customs\s+value:\s*([0-9.,]+)\s*USD/i;
    const sW = text.match(steelKgRe); const sV = text.match(steelValRe);
    if(sW || sV){ block.steel = { kg: sW? Number(sW[1].replace(/,/g,'')) : null, value: sV? Number(sV[1].replace(/,/g,'')) : null }; }
    // Aluminum
    const alumBlockRe = /9903[\.-]?85[\.-]?08[\s\S]*?(Total\s+aluminum\s+content\s*:\s*([0-9.,]+|N\/A))[\s\S]*?Total\s+customs\s+value\s*:\s*([0-9.,]+|N\/A)/i;
    const aM = text.match(alumBlockRe);
    if(aM){
      const qty = /N\/A/i.test(aM[2])? null : Number(aM[2].replace(/,/g,''));
      const val = /N\/A/i.test(aM[3])? null : Number(aM[3].replace(/,/g,''));
      block.alum = { kg: qty, value: val };
    }
    return block;
  }

  // Main line items (POS ...). Supports EA/PCS/KG/L/BTL/BUC and the ‚ÄúQty x Unit Price = Amount‚Äù layout.
  function parseLineItems(text){
    const rows=[];
    const re = /\bPOS\s*(\d{1,3})[\s\S]*?(?:Part\s*:?\\s*([A-Z0-9.\-\/]+))?[\s\S]*?Qty\s*[:]?\\s*([0-9.,]+)\s*([A-Za-z]+)[\s\S]*?Unit\s*Price\s*[:]?\\s*([0-9.,]+)[\s\S]*?Amount\s*[:]?\\s*([0-9.,]+)/gi;
    let m; while((m=re.exec(text))){
      rows.push({
        position: m[1],
        part_number: (m[2]||'').trim(),
        quantity: Number(m[3].replace(/,/g,'')),
        unit: (m[4]||'').toUpperCase(),
        unit_price: Number(m[5].replace(/,/g,'')),
        line_total: Number(m[6].replace(/,/g,'')),
      });
    }
    // Fallback: generic pattern (also handles BTL/BUC)
    if(rows.length===0){
      const alt = /(\d{1,3})\s+([0-9A-Z.\-\/]{4,})[\s\S]*?([0-9.,]+)\s*(EA|PCS|KG|L|BTL|BUC)\s*[x√ó]\s*([0-9.,]+)[\s\S]*?([0-9.,]+)/gi;
      let n; while((n=alt.exec(text))){
        rows.push({
          position:n[1], part_number:n[2],
          quantity:Number(n[3].replace(/,/g,'')),
          unit:n[4], unit_price:Number(n[5].replace(/,/g,'')),
          line_total:Number(n[6].replace(/,/g,''))
        });
      }
    }
    return rows;
  }

  function processPDFText(text){
    const header = parseInvoiceHeader(text);
    currentInvoice = header.invoice_number || '';
    const steelAlum = parseSteelAluminumBlock(text);
    const baseLines = parseLineItems(text);

    allData = [];
    baseLines.forEach(b=>{
      const base = {
        invoice_number: currentInvoice,
        invoice_date: header.invoice_date||'',
        invoice_total: header.invoice_total||'',
        supplier: header.supplier||'',
        position: String(b.position),
        part_number: b.part_number,
        quantity: b.quantity,
        unit: b.unit,
        unit_price: b.unit_price,
        line_total: b.line_total,
        country_of_origin: '',
        net_weight: (b.unit==='KG'? b.quantity : ''),
      };

      // Steel subline
      if(steelAlum.steel && (steelAlum.steel.kg||steelAlum.steel.value)){
        const sQty = steelAlum.steel.kg || '';
        const sVal = steelAlum.steel.value || '';
        const sLine = {
          ...base,
          position: base.position+'S',
          part_number: `STEEL - ${base.part_number}`,
          quantity: sQty,
          unit: 'KG',
          unit_price: '',
          line_total: sVal,
          net_weight: sQty
        };
        if(sVal!=='') base.line_total = Number(base.line_total||0) - Number(sVal);
        allData.push(base, sLine);
      } else {
        allData.push(base);
      }

      // Aluminum subline
      if(steelAlum.alum && (steelAlum.alum.kg||steelAlum.alum.value)){
        const aQty = steelAlum.alum.kg || '';
        const aVal = steelAlum.alum.value || '';
        const aLine = {
          ...base,
          position: base.position+'A',
          part_number: `ALUMINUM - ${base.part_number}`,
          quantity: aQty,
          unit: 'KG',
          unit_price: '',
          line_total: aVal,
          net_weight: aQty
        };
        if(aVal!=='') base.line_total = Number(base.line_total||0) - Number(aVal);
        allData.push(aLine);
      }
    });

    // Group base, then 10S, then 10A
    allData.sort((a,b)=>{
      const baseA = parseInt(String(a.position).replace(/[^0-9].*$/,''))||0;
      const baseB = parseInt(String(b.position).replace(/[^0-9].*$/,''))||0;
      if(baseA!==baseB) return baseA-baseB;
      const sufA = /[SA]$/.test(a.position)? a.position.slice(-1):'';
      const sufB = /[SA]$/.test(b.position)? b.position.slice(-1):'';
      const order = { '':0, 'S':1, 'A':2 };
      return (order[sufA]??0) - (order[sufB]??0);
    });

    renderTable();
    showAlert(`Parsed ${allData.length} row(s) from ${uploadedPdfName||'PDF'}`);
  }

  function renderTable(){
    const tbody = document.getElementById('tableBody');
    const table = document.getElementById('invoiceTable');
    tbody.innerHTML='';
    const rows = allData.filter(r=>r.invoice_number===currentInvoice);
    if(!rows.length){ table.style.display='none'; return; }
    table.style.display='table';
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td class="pos">${r.position||''}</td>
        <td>${r.part_number||''}</td>
        <td class="qty number">${fmt(r.quantity)}</td>
        <td class="unit">${r.unit||''}</td>
        <td class="number">${fmt(r.unit_price)}</td>
        <td class="number">${fmt(r.line_total)}</td>
        <td class="net number">${fmt(r.net_weight)}</td>
        <td class="country">${r.country_of_origin||''}</td>`;
      tbody.appendChild(tr);
    });
  }

  // ===================== DB LOAD & MAPS =====================
  function sheetToJsonByHeader(ws){ return XLSX.utils.sheet_to_json(ws,{defval:'',raw:true}); }
  function buildDbMaps(){
    htsUomMap = {}; partTariffsMap = {}; steelPartByTariff={}; alumPartByTariff={};
    if(!mankiDbWB) return;
    for(const sn of mankiDbWB.SheetNames){
      const ws = mankiDbWB.Sheets[sn]; const rows = sheetToJsonByHeader(ws)||[]; if(!rows.length) continue;
      const headers = Object.keys(rows[0]||{});

      // Sheet1 ‚Äî map tariff -> steel/alum part & supplier; record GENERIC rows
      if(/sheet\s*1/i.test(sn)){
        const hTar=headers.find(h=>/^(tariff|hts)/i.test(h))||headers[0];
        const hSteel=headers.find(h=>/steel/i.test(h));
        const hAlum=headers.find(h=>/alum/i.test(h));
        const hSupp=headers.find(h=>/supplier/i.test(h));
        rows.forEach(r=>{
          const raw=(r[hTar]||'')+''; const key=raw.replace(/[^0-9]/g,'');
          const sPart=(r[hSteel]||'')+''; const aPart=(r[hAlum]||'')+''; const supp=(r[hSupp]||'')+'';
          if(/^GENERIC/i.test(raw)){ if(sPart) genericSteelPart=sPart.trim(); if(aPart) genericAlumPart=aPart.trim(); return; }
          if(key){
            if(sPart) steelPartByTariff[key]={part:sPart.trim(),supplier:supp.trim()};
            if(aPart) alumPartByTariff[key]={part:aPart.trim(),supplier:supp.trim()};
          }
        });
      }

      // Any sheet with TARIFF NUM/TARIFF NUM_1... build part -> tariffs array
      if(!headers.some(h=>/tariff\s*num/i.test(h))) continue;
      const partKey = headers.find(h=>/part/i.test(h))||'PART NUMBER';
      rows.forEach(r=>{
        const part=(r[partKey]||'')+''; if(!part) return; const core=getPartCore(part);
        const tariffs=[]; headers.forEach(h=>{
          if(/tariff\s*num/i.test(h)){ const c=(r[h]||'')+''; const k=c.replace(/[^0-9]/g,''); if(k) tariffs.push(k); }
        });
        if(tariffs.length) partTariffsMap[core]=tariffs;
      });

      // UOM sheet (if present)
      if(/uom/i.test(sn)){
        rows.forEach(r=>{
          const k = (r['HTS Code']||r['HTS']||r['Tariff']||'')+''; const code=k.replace(/[^0-9]/g,'');
          const u1=(r['UOM1']||r['UOM 1']||r['PrimaryUOM']||'')+''; const u2=(r['UOM2']||r['UOM 2']||r['SecondaryUOM']||'')+'';
          if(code) htsUomMap[code] = {uom1:u1.trim(), uom2:u2.trim()};
        });
      }
    }
  }

  // ===================== EXPORT =====================
  function startsWith98or99(code){ return /^9[89]/.test(String(code||'')); }
  function choosePrimaryTariff(tariffs){ const non99=(tariffs||[]).filter(t=>!startsWith98or99(t)); return (non99[0]||(tariffs||[])[0]||'')+''; }
  function materialPartFor(tariffs, kind){
    const primary = choosePrimaryTariff(tariffs).replace(/[^0-9]/g,'');
    const map = (kind==='steel')? steelPartByTariff : alumPartByTariff;
    if(primary && map[primary]) return {part:map[primary].part, supplier:map[primary].supplier||''};
    for(const t of (tariffs||[])){ const k=String(t).replace(/[^0-9]/g,''); if(map[k]) return {part:map[k].part, supplier:map[k].supplier||''}; }
    return {part: (kind==='steel'?genericSteelPart:genericAlumPart), supplier:''};
  }

  async function tryFetchDefaultAssets(){
    if(!oneViewTemplateWB){
      try{ const r=await fetch('descartes_ci_upload.xlsx');
        if(r.ok){ const ab=await r.arrayBuffer(); oneViewTemplateWB=XLSX.read(new Uint8Array(ab), {type:'array'}); }
      }catch(e){}
    }
    if(!mankiDbWB){
      try{ const r2=await fetch('updated_manki_db.xlsx');
        if(r2.ok){ const ab2=await r2.arrayBuffer(); mankiDbWB=XLSX.read(new Uint8Array(ab2), {type:'array'}); buildDbMaps(); }
      }catch(e){}
    }
  }

  async function exportToOneView(){
    await tryFetchDefaultAssets();
    if(!oneViewTemplateWB){ showAlert('Load the OneView template (descartes_ci_upload.xlsx).','error'); return; }
    if(!mankiDbWB){ showAlert('Load updated_manki_db.xlsx for tariff/UOM lookups.','error'); return; }

    const tplName = oneViewTemplateWB.SheetNames[0];
    const ws      = oneViewTemplateWB.Sheets[tplName];
    const aoa     = XLSX.utils.sheet_to_json(ws,{header:1, blankrows:false});

    // Locate header
    const findHeader = (ws)=>{
      const a = XLSX.utils.sheet_to_json(ws,{header:1, blankrows:false});
      for(let i=0;i<Math.min(20,a.length);i++){
        const row = (a[i]||[]).map(v=>String(v||''));
        if(row.some(v=>/InvoiceNumber/i.test(v)) && row.some(v=>/TariffNumber/i.test(v))) return {rowIndex:i,row};
      }
      return {rowIndex:0,row:a[0]||[]};
    };
    const {rowIndex, row:hdr} = findHeader(ws);
    const hmap={}; (hdr||[]).forEach((n,i)=>{ hmap[String(n).trim().toLowerCase()] = i; });
    const colIdx = (arr)=>{ for(const k of arr){ const i=hmap[String(k).toLowerCase()]; if(i!=null) return i; } return -1; };

    const col = {
      InvoiceNumber: colIdx(['InvoiceNumber','Invoice No','InvNo']),
      InvoiceDate:   colIdx(['InvoiceDate','Invoice Date']),
      InvoiceTotal:  colIdx(['InvoiceTotal','Invoice Amount','TotalAmount']),
      SupplierName:  colIdx(['SupplierName','Supplier','Shipper']),
      BuyerPartNumber:    colIdx(['BuyerPartNumber','Buyer Part Number']),
      SupplierPartNumber: colIdx(['SupplierPartNumber','Supplier Part Number']),
      Quantity:      colIdx(['Quantity']),
      UnitOfMeasure: colIdx(['UnitOfMeasure','UOM']),
      UnitPrice:     colIdx(['UnitPrice','Price']),
      ItemTotal:     colIdx(['ItemTotal','LineTotal']),
      CountryOfOrigin: colIdx(['CountryOfOrigin','COO','Country']),
      NetWeight:     colIdx(['NetWeight','Net Weight']),
      TariffNumber:  colIdx(['TariffNumber']),
      SecondaryTariffNumber: colIdx(['SecondaryTariffNumber']),
      ThirdTariffNumber:  colIdx(['ThirdTariffNumber','Third TariffNumber']),
      FourthTariffNumber: colIdx(['4TariffNumber','FourthTariffNumber']),
      FifthTariffNumber:  colIdx(['5TariffNumber','FifthTariffNumber']),
      Quantity1: colIdx(['Quantity1']),
      UnitOfMeasure1: colIdx(['UnitOfMeasure1']),
      SecondaryQuantity1: colIdx(['Secondary Quantity1','SecondaryQuantity1']),
      SecondaryUnitOfMeasure1: colIdx(['Secondaryunitofmeasure1','Secondary UnitOfMeasure1']),
      SecondaryUnitOfMeasure2: colIdx(['secondaryunitofmeasure2','SecondaryUnitOfMeasure2'])
    };

    let outRow = rowIndex + 1;
    const items = allData.filter(d=>d.invoice_number===currentInvoice);
    const bases = items.filter(r=>/^\d+$/.test(String(r.position||'')));

    const setCell=(A,r,c,v)=>{ if(c<0) return; if(!A[r]) A[r]=[]; A[r][c]=v; };

    bases.forEach(base=>{
      const partCore = getPartCore(base.part_number);
      const tariffs  = partTariffsMap[partCore] || [];
      const [t1,t2,t3,t4,t5] = [tariffs[0]||'',tariffs[1]||'',tariffs[2]||'',tariffs[3]||'',tariffs[4]||''];
      const u1 = htsUomMap[String(t2).replace(/[^0-9]/g,'')] || {};

      if(!aoa[outRow]) aoa[outRow]=[];
      setCell(aoa,outRow,col.InvoiceNumber, currentInvoice);
      setCell(aoa,outRow,col.InvoiceDate,   base.invoice_date||'');
      setCell(aoa,outRow,col.InvoiceTotal,  base.invoice_total||'');
      setCell(aoa,outRow,col.SupplierName,  base.supplier||'');
      setCell(aoa,outRow,col.BuyerPartNumber,    partCore);
      setCell(aoa,outRow,col.SupplierPartNumber, partCore);
      setCell(aoa,outRow,col.Quantity,      base.quantity||'');
      setCell(aoa,outRow,col.UnitOfMeasure, base.unit||'');
      setCell(aoa,outRow,col.UnitPrice,     base.unit_price||'');
      setCell(aoa,outRow,col.ItemTotal,     base.line_total||'');
      setCell(aoa,outRow,col.CountryOfOrigin, base.country_of_origin||'');
      setCell(aoa,outRow,col.NetWeight,     base.net_weight||'');
      setCell(aoa,outRow,col.TariffNumber,          t1);
      setCell(aoa,outRow,col.SecondaryTariffNumber, t2);
      if(col.ThirdTariffNumber  >=0) setCell(aoa,outRow,col.ThirdTariffNumber,  t3);
      if(col.FourthTariffNumber >=0) setCell(aoa,outRow,col.FourthTariffNumber, t4);
      if(col.FifthTariffNumber  >=0) setCell(aoa,outRow,col.FifthTariffNumber,  t5);

      // If HTS doesn't start with 98/99, populate UOM quantities
      if(t1 && !/^9[89]/.test(t1)){
        setCell(aoa,outRow,col.Quantity1,      base.net_weight||base.quantity||'');
        setCell(aoa,outRow,col.UnitOfMeasure1, (htsUomMap[t1]||{}).uom1||'');
      }
      if(t2 && !/^9[89]/.test(t2)){
        setCell(aoa,outRow,col.SecondaryQuantity1,     (u1.uom1==='KG')? (base.net_weight||'') : (base.quantity||''));
        setCell(aoa,outRow,col.SecondaryUnitOfMeasure1, u1.uom1||'');
        setCell(aoa,outRow,col.SecondaryUnitOfMeasure2, u1.uom2||'');
      }
      outRow++;

      // --- Steel (10S) ---
      const steel = items.find(x=>String(x.position)===String(base.position)+'S');
      if(steel && parseFloat(steel.line_total||0)>0){
        const mp = materialPartFor([t1,t2,t3,t4,t5],'steel');
        if(!aoa[outRow]) aoa[outRow]=[];
        setCell(aoa,outRow,col.InvoiceNumber, currentInvoice);
        setCell(aoa,outRow,col.InvoiceDate,   base.invoice_date||'');
        setCell(aoa,outRow,col.InvoiceTotal,  base.invoice_total||'');
        setCell(aoa,outRow,col.SupplierName,  mp.supplier||base.supplier||'');
        setCell(aoa,outRow,col.BuyerPartNumber,    mp.part);
        setCell(aoa,outRow,col.SupplierPartNumber, mp.part);
        setCell(aoa,outRow,col.Quantity,      steel.quantity||steel.net_weight||'');
        setCell(aoa,outRow,col.UnitOfMeasure, 'KG');
        setCell(aoa,outRow,col.UnitPrice,     '');
        setCell(aoa,outRow,col.ItemTotal,     steel.line_total||'');
        setCell(aoa,outRow,col.CountryOfOrigin, base.country_of_origin||'');
        setCell(aoa,outRow,col.NetWeight,     steel.quantity||steel.net_weight||'');
        setCell(aoa,outRow,col.TariffNumber,          t1);
        setCell(aoa,outRow,col.SecondaryTariffNumber, t2);
        if(col.ThirdTariffNumber  >=0) setCell(aoa,outRow,col.ThirdTariffNumber,  t3);
        if(col.FourthTariffNumber >=0) setCell(aoa,outRow,col.FourthTariffNumber, t4);
        if(col.FifthTariffNumber  >=0) setCell(aoa,outRow,col.FifthTariffNumber,  t5);
        outRow++;
      }

      // --- Aluminum (10A) ---
      const alum = items.find(x=>String(x.position)===String(base.position)+'A');
      if(alum && parseFloat(alum.line_total||0)>0){
        const mp = materialPartFor([t1,t2,t3,t4,t5],'alum');
        if(!aoa[outRow]) aoa[outRow]=[];
        setCell(aoa,outRow,col.InvoiceNumber, currentInvoice);
        setCell(aoa,outRow,col.InvoiceDate,   base.invoice_date||'');
        setCell(aoa,outRow,col.InvoiceTotal,  base.invoice_total||'');
        setCell(aoa,outRow,col.SupplierName,  mp.supplier||base.supplier||'');
        setCell(aoa,outRow,col.BuyerPartNumber,    mp.part);
        setCell(aoa,outRow,col.SupplierPartNumber, mp.part);
        setCell(aoa,outRow,col.Quantity,      alum.quantity||alum.net_weight||'');
        setCell(aoa,outRow,col.UnitOfMeasure, 'KG');
        setCell(aoa,outRow,col.UnitPrice,     '');
        setCell(aoa,outRow,col.ItemTotal,     alum.line_total||'');
        setCell(aoa,outRow,col.CountryOfOrigin, base.country_of_origin||'');
        setCell(aoa,outRow,col.NetWeight,     alum.quantity||alum.net_weight||'');
        setCell(aoa,outRow,col.TariffNumber,          t1);
        setCell(aoa,outRow,col.SecondaryTariffNumber, t2);
        if(col.ThirdTariffNumber  >=0) setCell(aoa,outRow,col.ThirdTariffNumber,  t3);
        if(col.FourthTariffNumber >=0) setCell(aoa,outRow,col.FourthTariffNumber, t4);
        if(col.FifthTariffNumber  >=0) setCell(aoa,outRow,col.FifthTariffNumber,  t5);
        outRow++;
      }
    });

    const newWS = XLSX.utils.aoa_to_sheet(aoa);
    oneViewTemplateWB.Sheets[tplName] = newWS;
    const out = XLSX.write(oneViewTemplateWB,{type:'array',bookType:'xlsx'});
    const blob = new Blob([out],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=(uploadedPdfName?uploadedPdfName+'_':'')+'oneview_upload.xlsx';
    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  }

  // ===================== BUTTONS =====================
  document.getElementById('loadTplBtn').onclick=()=>document.getElementById('tplInput').click();
  document.getElementById('loadDbBtn').onclick =()=>document.getElementById('dbInput').click();
  document.getElementById('exportBtn').onclick =()=>exportToOneView();
  document.getElementById('clearBtn').onclick  =()=>{ allData=[]; currentInvoice=''; uploadedPdfName=''; document.getElementById('tableBody').innerHTML=''; document.getElementById('invoiceTable').style.display='none'; showAlert('Cleared.'); };

  document.getElementById('tplInput').addEventListener('change', e=>{
    const f=e.target.files?.[0]; if(!f) return; const r=new FileReader();
    r.onload=ev=>{ try{ oneViewTemplateWB=XLSX.read(new Uint8Array(ev.target.result),{type:'array'}); showAlert('Template loaded'); }catch(err){ showAlert('Template load failed','error'); } };
    r.readAsArrayBuffer(f);
  });
  document.getElementById('dbInput').addEventListener('change', e=>{
    const f=e.target.files?.[0]; if(!f) return; const r=new FileReader();
    r.onload=ev=>{ try{ mankiDbWB=XLSX.read(new Uint8Array(ev.target.result),{type:'array'}); buildDbMaps(); showAlert('Manki DB loaded'); }catch(err){ showAlert('DB load failed','error'); } };
    r.readAsArrayBuffer(f);
  });
</script>
</body>
</html>
